---
# Kind-specific Elasticsearch cluster configuration
# Source: generic/kubernetes/operator-based/elasticsearch/elasticsearch-cluster.yml
#
# Differences from the generic version:
#   - count: 2 (instead of 3) — the Kind cluster has 2 worker nodes by default,
#     and hard anti-affinity requires each ES pod on a separate node, so 3 replicas
#     would leave the 3rd pod in FailedScheduling.
#   - preferredDuringSchedulingIgnoredDuringExecution (instead of required) —
#     soft anti-affinity allows pods to colocate if needed, avoiding scheduling
#     failures in constrained local environments.
#   - Reduced resource requests/limits for local development.
#   - Reduced storage size for local development.

apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
    name: elasticsearch
spec:
    # renovate: datasource=docker depName=docker.elastic.co/elasticsearch/elasticsearch
    version: 8.19.11
    http:
        tls:
            selfSignedCertificate:
                disabled: true
    nodeSets:
        - name: masters
          count: 2
          config:
              # Disable mmap for compatibility with containers that lack the required vm.max_map_count sysctl
              # yamllint disable-line
              node.store.allow_mmap: 'false'
              # Disable deprecation warnings - https://github.com/camunda/camunda/issues/26285
              # yamllint disable-line
              logger.org.elasticsearch.deprecation: "OFF"
          podTemplate:
              spec:
                  affinity:
                      podAntiAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                              - weight: 100
                                podAffinityTerm:
                                    labelSelector:
                                        matchExpressions:
                                            - key: elasticsearch.k8s.elastic.co/cluster-name
                                              operator: In
                                              values:
                                                  - elasticsearch
                                    topologyKey: kubernetes.io/hostname
                  containers:
                      - name: elasticsearch
                        securityContext:
                            readOnlyRootFilesystem: true
                        env:
                            - name: ELASTICSEARCH_ENABLE_REST_TLS
                              value: 'false'
                            - name: READINESS_PROBE_TIMEOUT
                              value: '300'
                        resources:
                            requests:
                                cpu: 500m
                                memory: 1Gi
                            limits:
                                cpu: 1
                                memory: 1Gi
          volumeClaimTemplates:
              - metadata:
                    name: elasticsearch-data
                spec:
                    accessModes: [ReadWriteOnce]
                    resources:
                        requests:
                            storage: 16Gi
