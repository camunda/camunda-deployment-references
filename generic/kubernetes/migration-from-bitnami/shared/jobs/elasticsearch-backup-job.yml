---
# Elasticsearch Backup Job Template
# =============================================================================
# This template creates a Kubernetes Job for backing up Elasticsearch using
# the snapshot API.
#
# Prerequisites:
# - Snapshot repository must be registered in source Elasticsearch
# - Backup PVC must be mounted at the repository path
#
# Usage:
#   export ES_HOST="elasticsearch.namespace.svc.cluster.local"
#   export ES_PORT="9200"
#   export ES_IMAGE="docker.elastic.co/elasticsearch/elasticsearch:8.12.0"
#   export ES_USERNAME="elastic"
#   export ES_SECRET_NAME="elasticsearch-credentials"
#   export BACKUP_PVC="migration-backup-pvc"
#   export SNAPSHOT_REPO="migration_backup"
#   export SNAPSHOT_NAME="pre-migration-$(date +%Y%m%d-%H%M%S)"
#   export NAMESPACE="camunda"
#   export TIMESTAMP=$(date +%Y%m%d-%H%M%S)
#   envsubst < elasticsearch-backup-job.yml | kubectl apply -f -
# =============================================================================

apiVersion: batch/v1
kind: Job
metadata:
    name: es-backup-${TIMESTAMP}
    namespace: ${NAMESPACE}
    labels:
        app: orchestration-migration
        migration.camunda.io/type: backup
        migration.camunda.io/component: elasticsearch
spec:
    ttlSecondsAfterFinished: 3600
    backoffLimit: 2
    template:
        metadata:
            labels:
                app: orchestration-migration
                migration.camunda.io/type: backup
        spec:
            restartPolicy: Never
            # Uncomment and configure if using private registry
            # imagePullSecrets:
            #   - name: ${IMAGE_PULL_SECRET}
            containers:
                - name: backup
                  image: curlimages/curl:latest
                  command:
                      - /bin/sh
                      - -c
                      - |
                        set -e

                        echo "============================================="
                        echo "Elasticsearch Backup"
                        echo "============================================="
                        echo "Host: ${ES_HOST}:${ES_PORT}"
                        echo "Repository: ${SNAPSHOT_REPO}"
                        echo "Snapshot: ${SNAPSHOT_NAME}"
                        echo ""

                        # Build auth header
                        if [ -n "${ES_PASSWORD}" ]; then
                          AUTH="-u ${ES_USERNAME}:${ES_PASSWORD}"
                        else
                          AUTH=""
                        fi

                        # Check Elasticsearch is available
                        echo "Checking Elasticsearch connectivity..."
                        until curl -s ${AUTH} "http://${ES_HOST}:${ES_PORT}/_cluster/health" | grep -q '"status"'; do
                          echo "Waiting for Elasticsearch..."
                          sleep 5
                        done

                        echo "Elasticsearch is available"
                        curl -s ${AUTH} "http://${ES_HOST}:${ES_PORT}/_cluster/health" | head -c 200
                        echo ""
                        echo ""

                        # Check repository exists
                        echo "Checking snapshot repository..."
                        REPO_CHECK=$(curl -s -o /dev/null -w "%{http_code}" ${AUTH} \
                          "http://${ES_HOST}:${ES_PORT}/_snapshot/${SNAPSHOT_REPO}")

                        if [ "$REPO_CHECK" != "200" ]; then
                          echo "ERROR: Snapshot repository '${SNAPSHOT_REPO}' not found!"
                          echo "Please register the repository first using:"
                          echo "  curl -X PUT '${ES_HOST}:${ES_PORT}/_snapshot/${SNAPSHOT_REPO}' \\"
                          echo "    -H 'Content-Type: application/json' \\"
                          echo "    -d '{\"type\": \"fs\", \"settings\": {\"location\": \"/backup/elasticsearch\"}}'"
                          exit 1
                        fi

                        echo "Repository exists"
                        echo ""

                        # Create snapshot
                        echo "Creating snapshot: ${SNAPSHOT_NAME}"
                        curl -s -X PUT ${AUTH} \
                          "http://${ES_HOST}:${ES_PORT}/_snapshot/${SNAPSHOT_REPO}/${SNAPSHOT_NAME}?wait_for_completion=true" \
                          -H 'Content-Type: application/json' \
                          -d '{
                            "indices": "*",
                            "ignore_unavailable": true,
                            "include_global_state": false
                          }'

                        echo ""
                        echo ""

                        # Verify snapshot
                        echo "Verifying snapshot..."
                        SNAPSHOT_STATE=$(curl -s ${AUTH} \
                          "http://${ES_HOST}:${ES_PORT}/_snapshot/${SNAPSHOT_REPO}/${SNAPSHOT_NAME}" \
                          | grep -o '"state":"[^"]*"' | head -1)

                        echo "Snapshot state: ${SNAPSHOT_STATE}"

                        if echo "${SNAPSHOT_STATE}" | grep -q "SUCCESS"; then
                          echo ""
                          echo "Backup completed successfully!"
                        else
                          echo ""
                          echo "WARNING: Snapshot may not have completed successfully"
                          curl -s ${AUTH} "http://${ES_HOST}:${ES_PORT}/_snapshot/${SNAPSHOT_REPO}/${SNAPSHOT_NAME}"
                        fi

                  env:
                      - name: ES_PASSWORD
                        valueFrom:
                            secretKeyRef:
                                name: ${ES_SECRET_NAME}
                                key: elastic
                                optional: true
                  resources:
                      requests:
                          memory: 128Mi
                          cpu: 50m
                      limits:
                          memory: 256Mi
                          cpu: 200m
