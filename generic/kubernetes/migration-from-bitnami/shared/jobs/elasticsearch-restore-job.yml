---
# Elasticsearch Restore Job Template
# =============================================================================
# This template creates a Kubernetes Job for restoring Elasticsearch from
# a snapshot.
#
# Prerequisites:
# - Snapshot repository must be registered in target Elasticsearch (ECK)
# - Backup PVC with snapshot data must be accessible
# - Target indices should not exist (or use close/delete before restore)
#
# Usage:
#   export TARGET_ES_HOST="elasticsearch-es-http.namespace.svc.cluster.local"
#   export TARGET_ES_PORT="9200"
#   export ES_USERNAME="elastic"
#   export ES_SECRET_NAME="elasticsearch-es-elastic-user"
#   export SNAPSHOT_REPO="migration_backup"
#   export SNAPSHOT_NAME="pre-migration-20241216-120000"
#   export NAMESPACE="camunda"
#   export TIMESTAMP=$(date +%Y%m%d-%H%M%S)
#   envsubst < elasticsearch-restore-job.yml | kubectl apply -f -
# =============================================================================

apiVersion: batch/v1
kind: Job
metadata:
    name: es-restore-${TIMESTAMP}
    namespace: ${NAMESPACE}
    labels:
        app: orchestration-migration
        migration.camunda.io/type: restore
        migration.camunda.io/component: elasticsearch
spec:
    ttlSecondsAfterFinished: 3600
    backoffLimit: 2
    template:
        metadata:
            labels:
                app: orchestration-migration
                migration.camunda.io/type: restore
        spec:
            restartPolicy: Never
            containers:
                - name: restore
                  image: curlimages/curl:latest
                  command:
                      - /bin/sh
                      - -c
                      - |
                        set -e

                        echo "============================================="
                        echo "Elasticsearch Restore"
                        echo "============================================="
                        echo "Target: ${TARGET_ES_HOST}:${TARGET_ES_PORT}"
                        echo "Repository: ${SNAPSHOT_REPO}"
                        echo "Snapshot: ${SNAPSHOT_NAME}"
                        echo ""

                        # Build auth header
                        if [ -n "${ES_PASSWORD}" ]; then
                          AUTH="-u ${ES_USERNAME}:${ES_PASSWORD}"
                        else
                          AUTH=""
                        fi

                        # Check Elasticsearch is available
                        echo "Checking target Elasticsearch connectivity..."
                        until curl -s ${AUTH} "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_cluster/health" | grep -q '"status"'; do
                          echo "Waiting for Elasticsearch..."
                          sleep 5
                        done

                        echo "Target Elasticsearch is available"
                        curl -s ${AUTH} "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_cluster/health" | head -c 200
                        echo ""
                        echo ""

                        # Check repository exists
                        echo "Checking snapshot repository..."
                        REPO_CHECK=$(curl -s -o /dev/null -w "%{http_code}" ${AUTH} \
                          "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_snapshot/${SNAPSHOT_REPO}")

                        if [ "$REPO_CHECK" != "200" ]; then
                          echo "ERROR: Snapshot repository '${SNAPSHOT_REPO}' not found on target!"
                          echo "Please register the repository first."
                          exit 1
                        fi

                        echo "Repository exists"
                        echo ""

                        # List available snapshots
                        echo "Available snapshots:"
                        curl -s ${AUTH} "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_snapshot/${SNAPSHOT_REPO}/_all" \
                          | grep -o '"snapshot":"[^"]*"' || echo "  (none or error listing)"
                        echo ""

                        # Check snapshot exists
                        echo "Checking snapshot: ${SNAPSHOT_NAME}"
                        SNAP_CHECK=$(curl -s -o /dev/null -w "%{http_code}" ${AUTH} \
                          "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_snapshot/${SNAPSHOT_REPO}/${SNAPSHOT_NAME}")

                        if [ "$SNAP_CHECK" != "200" ]; then
                          echo "ERROR: Snapshot '${SNAPSHOT_NAME}' not found!"
                          exit 1
                        fi

                        echo "Snapshot found"
                        echo ""

                        # Get indices in snapshot
                        echo "Indices in snapshot:"
                        curl -s ${AUTH} "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_snapshot/${SNAPSHOT_REPO}/${SNAPSHOT_NAME}" \
                          | grep -o '"indices":\[[^]]*\]' || echo "  (could not parse indices)"
                        echo ""

                        # Close existing indices that will be restored (if any)
                        echo "Closing any existing indices that match snapshot..."
                        INDICES=$(curl -s ${AUTH} "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_snapshot/${SNAPSHOT_REPO}/${SNAPSHOT_NAME}" \
                          | grep -o '"indices":\[[^]]*\]' | sed 's/"indices":\[//;s/\]//;s/"//g;s/,/ /g')

                        for idx in $INDICES; do
                          echo "  Closing index: $idx"
                          curl -s -X POST ${AUTH} "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/${idx}/_close" 2>/dev/null || true
                        done
                        echo ""

                        # Restore snapshot
                        echo "Restoring snapshot: ${SNAPSHOT_NAME}"
                        curl -s -X POST ${AUTH} \
                          "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_snapshot/${SNAPSHOT_REPO}/${SNAPSHOT_NAME}/_restore?wait_for_completion=true" \
                          -H 'Content-Type: application/json' \
                          -d '{
                            "indices": "*",
                            "ignore_unavailable": true,
                            "include_global_state": false,
                            "include_aliases": true
                          }'

                        echo ""
                        echo ""

                        # Verify restore
                        echo "Verifying restore..."
                        echo "Cluster health:"
                        curl -s ${AUTH} "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_cluster/health"
                        echo ""

                        echo ""
                        echo "Indices after restore:"
                        curl -s ${AUTH} "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_cat/indices?v"

                        echo ""
                        echo "Restore complete!"

                  env:
                      - name: ES_PASSWORD
                        valueFrom:
                            secretKeyRef:
                                name: ${ES_SECRET_NAME}
                                key: elastic
                                optional: true
                  resources:
                      requests:
                          memory: 128Mi
                          cpu: 50m
                      limits:
                          memory: 256Mi
                          cpu: 200m
