---
# Elasticsearch Restore Job
# Required env vars:
#   NAMESPACE, JOB_NAME, ES_IMAGE, TARGET_ES_HOST, TARGET_ES_PORT
#   TARGET_ES_USERNAME, TARGET_ES_SECRET_NAME, TARGET_ES_SECRET_KEY
#   BACKUP_PVC, SNAPSHOT_NAME, SNAPSHOT_REPO
# Usage: envsubst < es-restore-job.yml | kubectl apply -f -
apiVersion: batch/v1
kind: Job
metadata:
    name: ${JOB_NAME}
    namespace: ${NAMESPACE}
    labels:
        app: orchestration-migration
        migration.camunda.io/type: restore
        migration.camunda.io/component: elasticsearch
spec:
    ttlSecondsAfterFinished: 3600
    backoffLimit: 2
    template:
        metadata:
            labels:
                app: orchestration-migration
                migration.camunda.io/type: restore
        spec:
            restartPolicy: Never
            containers:
                - name: restore
                  image: ${ES_IMAGE}
                  command:
                      - /bin/bash
                      - -c
                      - |
                        set -e

                        echo "============================================="
                        echo "Elasticsearch Restore"
                        echo "============================================="
                        echo "Target: ${TARGET_ES_HOST}:${TARGET_ES_PORT}"
                        echo "Snapshot: ${SNAPSHOT_NAME}"
                        echo ""

                        echo "Waiting for target Elasticsearch to be ready..."
                        until curl -s -u "${TARGET_ES_USERNAME}:${ES_PASSWORD}" \
                          "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_cluster/health" | \
                          grep -q '"status":"green"\|"status":"yellow"'; do
                          echo "Waiting for Elasticsearch..."
                          sleep 5
                        done

                        echo "Target Elasticsearch is ready"

                        # Register snapshot repository on target
                        echo "Registering snapshot repository on target..."
                        curl -X PUT -u "${TARGET_ES_USERNAME}:${ES_PASSWORD}" \
                          "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_snapshot/${SNAPSHOT_REPO}" \
                          -H "Content-Type: application/json" \
                          -d '{
                            "type": "fs",
                            "settings": {
                              "location": "/backup/elasticsearch",
                              "compress": true
                            }
                          }'

                        echo ""

                        # Delete existing Camunda indices (as per Camunda docs)
                        echo "Deleting existing Camunda indices..."
                        for index in $(curl -s -u "${TARGET_ES_USERNAME}:${ES_PASSWORD}" \
                          "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_cat/indices?h=index" \
                          | grep -E 'camunda|operate|tasklist|optimize|zeebe' || true); do
                          echo "  Deleting index: $index"
                          curl -s -X DELETE -u "${TARGET_ES_USERNAME}:${ES_PASSWORD}" \
                            "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/$index" || true
                        done

                        echo ""

                        # Verify snapshot exists
                        echo "Verifying snapshot..."
                        curl -s -u "${TARGET_ES_USERNAME}:${ES_PASSWORD}" \
                          "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_snapshot/${SNAPSHOT_REPO}/${SNAPSHOT_NAME}" | jq .

                        # Restore snapshot
                        echo "Starting restore..."
                        curl -X POST -u "${TARGET_ES_USERNAME}:${ES_PASSWORD}" \
                          "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_snapshot/${SNAPSHOT_REPO}/${SNAPSHOT_NAME}/_restore?wait_for_completion=true" \
                          -H "Content-Type: application/json" \
                          -d '{
                            "indices": "*",
                            "ignore_unavailable": true,
                            "include_global_state": false
                          }'

                        echo ""
                        echo "Restore completed!"

                        # Wait for indices to be ready
                        echo "Waiting for indices to be ready..."
                        sleep 10

                        # Show index status
                        echo "Index status:"
                        curl -s -u "${TARGET_ES_USERNAME}:${ES_PASSWORD}" \
                          "http://${TARGET_ES_HOST}:${TARGET_ES_PORT}/_cat/indices?v"

                  env:
                      - name: ES_PASSWORD
                        valueFrom:
                            secretKeyRef:
                                name: ${TARGET_ES_SECRET_NAME}
                                key: ${TARGET_ES_SECRET_KEY}
                  resources:
                      requests:
                          memory: 256Mi
                          cpu: 100m
                      limits:
                          memory: 512Mi
                          cpu: 500m
                  volumeMounts:
                      - name: backup
                        mountPath: /backup
            volumes:
                - name: backup
                  persistentVolumeClaim:
                      claimName: ${BACKUP_PVC}
