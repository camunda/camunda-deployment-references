---
# ECK Elasticsearch Cluster
# Based on: operator-based/elasticsearch/elasticsearch-cluster.yml
# Required env vars:
#   NAMESPACE, ECK_CLUSTER_NAME, ES_VERSION
#   ES_REPLICAS, ES_STORAGE_SIZE, BACKUP_PVC
# Optional: ES_MEMORY_REQUEST, ES_MEMORY_LIMIT, ES_CPU_REQUEST, ES_CPU_LIMIT
# Usage: envsubst < eck-cluster.yml | kubectl apply -f -
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
    name: ${ECK_CLUSTER_NAME}
    namespace: ${NAMESPACE}
    labels:
        app: orchestration-migration
        migration.camunda.io/component: elasticsearch
spec:
    version: ${ES_VERSION}
    http:
        tls:
            selfSignedCertificate:
                disabled: true
    nodeSets:
        - name: masters
          count: ${ES_REPLICAS}
          config:
              # Disable mmap for containers
              node.store.allow_mmap: false
              # Disable deprecation warnings - https://github.com/camunda/camunda/issues/26285
              logger.org.elasticsearch.deprecation: off
              # Repository for snapshots (for migration restore)
              path.repo: [/backup/elasticsearch]
          podTemplate:
              spec:
                  affinity:
                      podAntiAffinity:
                          requiredDuringSchedulingIgnoredDuringExecution:
                              - labelSelector:
                                    matchExpressions:
                                        - key: elasticsearch.k8s.elastic.co/cluster-name
                                          operator: In
                                          values:
                                              - ${ECK_CLUSTER_NAME}
                                topologyKey: kubernetes.io/hostname
                  containers:
                      - name: elasticsearch
                        securityContext:
                            readOnlyRootFilesystem: true
                        env:
                            - name: ELASTICSEARCH_ENABLE_REST_TLS
                              value: 'false'
                            - name: READINESS_PROBE_TIMEOUT
                              value: '300'
                        resources:
                            requests:
                                cpu: ${ES_CPU_REQUEST}
                                memory: ${ES_MEMORY_REQUEST}
                            limits:
                                cpu: ${ES_CPU_LIMIT}
                                memory: ${ES_MEMORY_LIMIT}
                        volumeMounts:
                            - name: backup
                              mountPath: /backup
                  volumes:
                      - name: backup
                        persistentVolumeClaim:
                            claimName: ${BACKUP_PVC}
          volumeClaimTemplates:
              - metadata:
                    name: elasticsearch-data
                spec:
                    accessModes: [ReadWriteOnce]
                    resources:
                        requests:
                            storage: ${ES_STORAGE_SIZE}
