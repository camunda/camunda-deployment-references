---
# PostgreSQL Backup Job using pg_dump
# Required env vars:
#   NAMESPACE, JOB_NAME, PG_IMAGE, PG_HOST, PG_PORT
#   PG_DATABASE, PG_USERNAME, PG_SECRET_NAME, PG_SECRET_KEY
#   BACKUP_PVC, BACKUP_FILE
# Usage: envsubst < backup-job.yml | kubectl apply -f -
apiVersion: batch/v1
kind: Job
metadata:
    name: ${JOB_NAME}
    namespace: ${NAMESPACE}
    labels:
        app: webmodeler-migration
        migration.camunda.io/type: backup
        migration.camunda.io/component: postgresql
spec:
    ttlSecondsAfterFinished: 3600
    backoffLimit: 2
    template:
        metadata:
            labels:
                app: webmodeler-migration
                migration.camunda.io/type: backup
        spec:
            restartPolicy: Never
            containers:
                - name: backup
                  image: ${PG_IMAGE}
                  command:
                      - /bin/bash
                      - -c
                      - |
                        set -e

                        echo "============================================="
                        echo "PostgreSQL Backup - WebModeler"
                        echo "============================================="
                        echo "Host: ${PG_HOST}:${PG_PORT}"
                        echo "Database: ${PG_DATABASE}"
                        echo ""

                        echo "Waiting for PostgreSQL to be ready..."
                        until pg_isready -h "${PG_HOST}" -p "${PG_PORT}" -U "${PGUSER}"; do
                          echo "Waiting for PostgreSQL..."
                          sleep 5
                        done

                        echo "PostgreSQL is ready"

                        mkdir -p /backup/webmodeler

                        echo "Creating database backup..."
                        pg_dump -h "${PG_HOST}" -p "${PG_PORT}" -U "${PGUSER}" -d "${PG_DATABASE}" \
                          -F custom -f "/backup/webmodeler/${BACKUP_FILE}"

                        echo ""
                        echo "Backup complete!"
                        ls -lh /backup/webmodeler/

                        # Count tables for validation
                        echo ""
                        echo "Tables in backup:"
                        pg_restore --list "/backup/webmodeler/${BACKUP_FILE}" | grep "TABLE" | wc -l

                  env:
                      - name: PGUSER
                        value: ${PG_USERNAME}
                      - name: PGPASSWORD
                        valueFrom:
                            secretKeyRef:
                                name: ${PG_SECRET_NAME}
                                key: ${PG_SECRET_KEY}
                  volumeMounts:
                      - name: backup
                        mountPath: /backup
            volumes:
                - name: backup
                  persistentVolumeClaim:
                      claimName: ${BACKUP_PVC}
