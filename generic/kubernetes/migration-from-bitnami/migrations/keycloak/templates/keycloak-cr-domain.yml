---
apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
    name: ${KEYCLOAK_CR_NAME}
    namespace: ${NAMESPACE}
    labels:
        app: keycloak-migration
        migration.camunda.io/component: keycloak
spec:
    image: ${KC_IMAGE}
    instances: ${KC_REPLICAS}
    db:
        # Use official url parameter instead of individual host/port/database
        # aws-wrapper is required for optimized images (no impact on functionality)
        url: jdbc:aws-wrapper:postgresql://${CNPG_CLUSTER_NAME}-rw:5432/${PG_DATABASE}
        schema: public
        usernameSecret:
            name: ${CNPG_CLUSTER_NAME}-secret
            key: username
        passwordSecret:
            name: ${CNPG_CLUSTER_NAME}-secret
            key: password
    http:
        httpEnabled: true
    additionalOptions:
        - name: http-relative-path
          value: /auth
        # Enable proxy mode for proper HTTPS redirect handling behind nginx ingress
        - name: proxy-headers
          value: xforwarded
        # Trust X-Forwarded-* headers from proxy
        - name: hostname-strict-https
          value: 'true'
    ingress:
        # Ingress disabled - using separate Ingress object with path /auth
        enabled: false
    hostname:
        hostname: ${CAMUNDA_DOMAIN}
        # Dynamic backchannel for ingress environments
        backchannelDynamic: false
        strict: true
    resources:
        limits:
            cpu: 500m
            memory: 1Gi
        requests:
            cpu: 250m
            memory: 512Mi
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
    name: keycloak-ingress
    namespace: ${NAMESPACE}
    labels:
        app: keycloak-migration
        migration.camunda.io/component: keycloak
    annotations:
        # TLS secret for HTTPS (cert-manager will create this automatically)
        kubernetes.io/tls-acme: 'true'
        # Ensure proper HTTPS handling for Keycloak behind proxy
        nginx.ingress.kubernetes.io/ssl-redirect: 'true'
        nginx.ingress.kubernetes.io/force-ssl-redirect: 'true'
spec:
    ingressClassName: nginx
    tls:
        - hosts:
              - ${CAMUNDA_DOMAIN}
          secretName: camunda-keycloak-tls
    rules:
        - host: ${CAMUNDA_DOMAIN}
          http:
              paths:
                  - path: /auth
                    pathType: Prefix
                    backend:
                        service:
                            name: ${KEYCLOAK_CR_NAME}-service
                            port:
                                number: 8080
