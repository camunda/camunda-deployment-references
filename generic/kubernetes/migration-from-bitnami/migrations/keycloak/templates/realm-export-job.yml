---
# Keycloak Realm Export Job
# Required env vars:
#   NAMESPACE, JOB_NAME, KC_HOST, KC_PORT
#   KC_ADMIN_USER, KC_ADMIN_PASSWORD
#   BACKUP_PVC
# Usage: envsubst < realm-export-job.yml | kubectl apply -f -
apiVersion: batch/v1
kind: Job
metadata:
    name: ${JOB_NAME}
    namespace: ${NAMESPACE}
    labels:
        app: keycloak-migration
        migration.camunda.io/type: backup
        migration.camunda.io/component: keycloak
spec:
    ttlSecondsAfterFinished: 3600
    backoffLimit: 2
    template:
        metadata:
            labels:
                app: keycloak-migration
                migration.camunda.io/type: backup
        spec:
            restartPolicy: Never
            containers:
                - name: export
                  image: curlimages/curl:latest
                  command:
                      - /bin/sh
                      - -c
                      - |
                        set -e

                        echo "============================================="
                        echo "Keycloak Realm Export"
                        echo "============================================="
                        echo "Host: ${KC_HOST}:${KC_PORT}"
                        echo ""

                        echo "Waiting for Keycloak to be ready..."
                        until curl -sf "http://${KC_HOST}:${KC_PORT}/auth/health/ready" >/dev/null 2>&1 || \
                              curl -sf "http://${KC_HOST}:${KC_PORT}/health/ready" >/dev/null 2>&1; do
                          echo "Waiting for Keycloak..."
                          sleep 5
                        done

                        echo "Keycloak is ready"

                        # Detect the correct auth endpoint (Keycloak 17+ uses /realms/master, older uses /auth/realms/master)
                        AUTH_ENDPOINT=""
                        if curl -sf "http://${KC_HOST}:${KC_PORT}/realms/master/.well-known/openid-configuration" >/dev/null 2>&1; then
                          AUTH_ENDPOINT="http://${KC_HOST}:${KC_PORT}"
                        else
                          AUTH_ENDPOINT="http://${KC_HOST}:${KC_PORT}/auth"
                        fi

                        echo "Using auth endpoint: ${AUTH_ENDPOINT}"

                        # Get admin token
                        echo "Getting admin token..."
                        TOKEN=$(curl -s -X POST "${AUTH_ENDPOINT}/realms/master/protocol/openid-connect/token" \
                          -H "Content-Type: application/x-www-form-urlencoded" \
                          -d "username=${KC_ADMIN_USER}" \
                          -d "password=${KC_ADMIN_PASSWORD}" \
                          -d "grant_type=password" \
                          -d "client_id=admin-cli" | jq -r '.access_token')

                        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
                          echo "Failed to get admin token"
                          exit 1
                        fi

                        echo "Got admin token"

                        # List realms
                        echo "Listing realms..."
                        REALMS=$(curl -s "${AUTH_ENDPOINT}/admin/realms" \
                          -H "Authorization: Bearer $TOKEN" | jq -r '.[].realm')

                        echo "Found realms: $REALMS"

                        # Export each realm
                        mkdir -p /backup/keycloak

                        for realm in $REALMS; do
                          echo "Exporting realm: $realm"
                          curl -s "${AUTH_ENDPOINT}/admin/realms/$realm" \
                            -H "Authorization: Bearer $TOKEN" > "/backup/keycloak/realm-$realm.json"

                          # Also export users for non-master realms
                          if [ "$realm" != "master" ]; then
                            echo "Exporting users for realm: $realm"
                            curl -s "${AUTH_ENDPOINT}/admin/realms/$realm/users?max=10000" \
                              -H "Authorization: Bearer $TOKEN" > "/backup/keycloak/users-$realm.json"
                          fi
                        done

                        echo ""
                        echo "Realm export complete!"
                        ls -la /backup/keycloak/

                  volumeMounts:
                      - name: backup
                        mountPath: /backup
            volumes:
                - name: backup
                  persistentVolumeClaim:
                      claimName: ${BACKUP_PVC}
