---
# OIDC Overlay Configuration for Camunda Platform
#
# This file contains ONLY the OIDC-specific configuration to replace Keycloak.
# It should be merged with your base values file using yq:
#   yq ". *+ load("values-oidc.yml")" values-domain.yml > values.yml
#
# Required environment variables (use envsubst before applying):
#   - OIDC_ISSUER_URL: OIDC issuer URL
#   - OIDC_TOKEN_URL: OAuth2 token endpoint
#   - OIDC_AUTHORIZATION_URL: OAuth2 authorization endpoint
#   - OIDC_JWKS_URL: JWKS endpoint for token validation
#   - IDENTITY_CLIENT_ID: Identity client ID
#   - OPTIMIZE_CLIENT_ID: Optimize client ID
#   - ORCHESTRATION_CLIENT_ID: Orchestration client ID
#   - CONNECTORS_CLIENT_ID: Connectors client ID
#   - CONSOLE_CLIENT_ID: Console client ID
#   - WEBMODELER_UI_CLIENT_ID: WebModeler UI client ID
#   - IDENTITY_INITIAL_USER_EMAIL: Initial admin user email
#   - DOMAIN_NAME: Your domain name for callbacks

global:
    identity:
        auth:
            type: GENERIC
            issuer: ${OIDC_ISSUER_URL}
            issuerBackendUrl: ${OIDC_ISSUER_URL}
            tokenUrl: ${OIDC_TOKEN_URL}
            jwksUrl: ${OIDC_JWKS_URL}
            authorizationUrl: ${OIDC_AUTHORIZATION_URL}

            identity:
                clientId: ${IDENTITY_CLIENT_ID}
                audience: ${IDENTITY_CLIENT_ID}
                existingSecret: camunda-oidc-identity-secret
                existingSecretKey: client-secret
                redirectUrl: https://${DOMAIN_NAME}/auth/login-callback

            optimize:
                clientId: ${OPTIMIZE_CLIENT_ID}
                audience: ${OPTIMIZE_CLIENT_ID}
                existingSecret: camunda-oidc-optimize-secret
                existingSecretKey: client-secret
                redirectUrl: https://${DOMAIN_NAME}/optimize/api/authentication/callback

            webModeler:
                clientId: ${WEBMODELER_UI_CLIENT_ID}
                redirectUrl: https://${DOMAIN_NAME}/modeler/login-callback

            console:
                clientId: ${CONSOLE_CLIENT_ID}
                audience: ${CONSOLE_CLIENT_ID}
                redirectUrl: https://${DOMAIN_NAME}/console/

            # Remove Keycloak-specific configurations
            admin:

identity:
    enabled: true

    firstUser:
        enabled: false

    keycloak:
        enabled: false

    contextPath: /auth

    fullURL: https://${DOMAIN_NAME}/auth

    env:
        - name: IDENTITY_AUTH_PROVIDER_BACKEND_URL
          value: ${OIDC_ISSUER_URL}
        - name: IDENTITY_AUTH_PROVIDER_ISSUER_URL
          value: ${OIDC_ISSUER_URL}
        - name: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUERURI
          value: ${OIDC_ISSUER_URL}
        - name: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWKSETURI
          value: ${OIDC_JWKS_URL}
        - name: IDENTITY_INITIAL_CLAIM_NAME
          value: email
        - name: IDENTITY_INITIAL_CLAIM_VALUE
          value: ${IDENTITY_INITIAL_USER_EMAIL}

identityKeycloak:
    enabled: false

connectors:
    env:
        - name: CAMUNDA_IDENTITY_ISSUER_BACKEND_URL
          value: ${OIDC_ISSUER_URL}

    security:
        authentication:
            oidc:
                clientId: ${CONNECTORS_CLIENT_ID}
                existingSecret: camunda-oidc-connectors-secret
                existingSecretKey: client-secret
                secret:

optimize:
    env:
        - name: CAMUNDA_OPTIMIZE_SECURITY_AUTH_CCSM_ISSUER_URL
          value: ${OIDC_ISSUER_URL}
        - name: CAMUNDA_OPTIMIZE_SECURITY_AUTH_CCSM_JWKS_URL
          value: ${OIDC_JWKS_URL}

orchestration:
    env:
        - name: CAMUNDA_IDENTITY_ISSUER_BACKEND_URL
          value: ${OIDC_ISSUER_URL}

    security:
        authentication:
            oidc:
                clientId: ${ORCHESTRATION_CLIENT_ID}
                existingSecret: camunda-oidc-orchestration-secret
                existingSecretKey: client-secret
                redirectUrl: https://${DOMAIN_NAME}/sso-callback
                secret:
        initialization:
            defaultRoles:
                admin:
                    users:
                        - ${IDENTITY_INITIAL_USER_EMAIL}

console:
    env:
        - name: CAMUNDA_IDENTITY_ISSUER_BACKEND_URL
          value: ${OIDC_ISSUER_URL}

webModeler:
    restapi:
        env:
            - name: CAMUNDA_IDENTITY_BASE_URL
              value: https://${DOMAIN_NAME}/auth
            - name: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUERURI
              value: ${OIDC_ISSUER_URL}

    webapp:
        env:
            - name: OAUTH2_CLIENT_ID
              value: ${WEBMODELER_UI_CLIENT_ID}
            - name: OAUTH2_JWKS_URL
              value: ${OIDC_JWKS_URL}
            - name: OAUTH2_TOKEN_AUDIENCE
              value: ${WEBMODELER_UI_CLIENT_ID}
            - name: OAUTH2_TOKEN_ISSUER
              value: ${OIDC_ISSUER_URL}
