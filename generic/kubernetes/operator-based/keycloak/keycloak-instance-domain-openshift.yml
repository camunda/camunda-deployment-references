---
apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
    name: keycloak
spec:
    # TODO: renovate to be tested
    # renovate: datasource=docker depName=camunda/keycloak versioning=regex:^quay-optimized-(?<version>.*)$
    image: docker.io/camunda/keycloak:quay-optimized-26.3.2
    instances: 1
    db:
        host: pg-keycloak-rw # this service is provided by the CNPG keycloak
        port: 5432
        database: keycloak
        schema: public
        usernameSecret:
            name: pg-keycloak-secret
            key: username
        passwordSecret:
            name: pg-keycloak-secret
            key: password
    http:
        httpEnabled: true
    # Required for optimized images - must use aws-wrapper URL format
    unsupported:
        podTemplate:
            spec:
                containers:
                    - name: keycloak
                      env:
                          - name: KC_DB_URL
                            value: jdbc:aws-wrapper:postgresql://pg-keycloak-rw:5432/keycloak
    ingress:
        enabled: true
        className: openshift-default
        rules:
            - host: ${CAMUNDA_DOMAIN}
              paths:
                  - path: /auth
        annotations:
            route.openshift.io/termination: edge
    hostname:
        hostname: ${CAMUNDA_DOMAIN}
        # Dynamic backchannel for ingress environments (set to false for localhost/no-ingress)
        backchannelDynamic: true
        strict: true
    resources:
        limits:
            cpu: 500m
            memory: 1Gi
        requests:
            cpu: 250m
            memory: 512Mi
