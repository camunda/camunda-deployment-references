---
name: Internal - Global - Maintenance

# This workflow performs automated maintenance tasks on Renovate pull requests:
# - Runs 'go mod tidy' to ensure Go dependencies are up to date
# - Regenerates golden files using 'just regenerate-golden-file-all'
# - Automatically commits any changes detected
#
# This helps keep the repository in sync with dependency updates and
# ensures golden files remain current with the latest infrastructure changes.

on:
    pull_request:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true
env:
    AWS_PROFILE: infraex
    AWS_REGION: eu-west-2
    S3_BACKEND_BUCKET: tests-ra-aws-rosa-hcp-tf-state-eu-central-1
    S3_BUCKET_REGION: eu-central-1
    S3_BUCKET_KEY: golden.tfstate

jobs:
    maintenance:
        name: Automated maintenance
        runs-on: ubuntu-latest
        permissions:
            id-token: write # required for azure login
            contents: write # allow commits
        if: github.event.pull_request.user.login == 'renovate[bot]'
        steps:
            - name: Generate token for GitHub
              id: generate-github-token
              uses: camunda/infra-global-github-actions/generate-github-app-token-from-vault-secrets@1f5a9aec53f142d600b6d0bfea8533b860a65367 # main
              with:
                  github-app-id-vault-key: GITHUB_APP_ID
                  github-app-id-vault-path: secret/data/products/infrastructure-experience/ci/common
                  github-app-private-key-vault-key: GITHUB_APP_PRIVATE_KEY
                  github-app-private-key-vault-path: secret/data/products/infrastructure-experience/ci/common
                  vault-auth-method: approle
                  vault-auth-role-id: ${{ secrets.VAULT_ROLE_ID }}
                  vault-auth-secret-id: ${{ secrets.VAULT_SECRET_ID }}
                  vault-url: ${{ secrets.VAULT_ADDR }}

            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
              with:
                  token: ${{ steps.generate-github-token.outputs.token }}

            - name: Install asdf tools with cache
              uses: camunda/infraex-common-config/.github/actions/asdf-install-tooling@b52f5bb65b5bb9e0b0458c46b8671bf1fe9a907f # 1.5.7

            - name: Run go mod tidy
              run: |
                  echo "Running 'go mod tidy' on all go.mod files..."
                  find . -name 'go.mod' -execdir sh -c 'echo "Processing $(pwd)/go.mod" && go mod tidy' \;
                  echo "âœ… 'go mod tidy' completed successfully"
            - name: Check for changes
              id: check-changes
              run: |
                  if [[ -n $(git status --porcelain) ]]; then
                    echo "changes=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "changes=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Commit changes
              if: steps.check-changes.outputs.changes == 'true'
              uses: getsentry/action-github-commit@5972d5f578ad77306063449e718c0c2a6fbc4ae1 # main
              with:
                  github-token: ${{ steps.generate-github-token.outputs.token }}
                  message: 'chore: update from scheduled maintenance (go mod tidy & just regenerate)'
