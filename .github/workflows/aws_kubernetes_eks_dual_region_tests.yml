---
name: Tests - Integration - AWS Kubernetes EKS Dual Region

permissions:
    contents: read # don't allow commits
    pull-requests: write # allow comments, labels (used by internal-apply-skip-label)

on:
    schedule:
        - cron: 0 2 * * 1 # 02:00 UTC on Monday
    workflow_dispatch:
        inputs:
            cluster_name:
                description: Cluster name.
                required: false
                type: string
            delete_clusters:
                description: Whether to delete the clusters.
                type: boolean
                default: true
            enable_tests:
                description: Whether to enable the tests.
                type: boolean
                default: true
            ref-arch:
                description: |
                    Reference architecture to use, can only deploy one at a time.
                    Use a different trigger with unique names for each ref-arch.
                    Valid values are `eks-dual-region`.
                    Only for workflow_dispatch.
                required: false
                type: string
                default: eks-dual-region
    pull_request:
        # For now limit automatic execution to a minimum, can always be done manually via workflow_dispatch for a branch
        paths:
            - .github/actions/setup-aws/action.yml
            - .github/workflows/nightly_aws_operational_procedure_snapshot.yml
            - .github/workflows/reuseable_aws_operational_procedure.yml
            - aws/dual-region/terraform/**
            - test/**
            - .tools-versions

# limit to a single execution per actor of this workflow
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    # we don't cancel the previous run, so it can finish it and let clusters in a proper state
    cancel-in-progress: false

env:
    IS_SCHEDULE: ${{ contains(github.head_ref, 'schedules/') || github.event_name == 'schedule' && 'true' || 'false' }}
    IS_RENOVATE_PR: ${{ github.event_name == 'pull_request' && github.event.pull_request.user.login == 'renovate[bot]' }}

    AWS_PROFILE: infraex
    AWS_REGION: eu-west-2
    TESTS_TF_BINARY_NAME: terraform
    S3_BACKEND_BUCKET: tf-state-multi-reg
    S3_BUCKET_REGION: eu-central-1

    CLEANUP_CLUSTERS: ${{ github.event.inputs.delete_clusters || 'true' }}

    # TEST VARIABLES

    # Vars with "CI_" prefix are used in the CI workflow only.
    CI_MATRIX_FILE: .github/workflows-config/aws-kubernetes-eks-dual-region/test_matrix.yml
    TF_VAR_default_tags: '{"map-migrated": "migARUADZHVWZ"}'
    TESTS_ENABLED: ${{ github.event.inputs.enable_tests || 'true' }}

jobs:
    triage:
        runs-on: ubuntu-latest
        outputs:
            should_skip: ${{ steps.skip_check.outputs.should_skip }}
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
            - name: Check labels
              id: skip_check
              uses: ./.github/actions/internal-triage-skip

    clusters-info:
        needs:
            - triage
        if: needs.triage.outputs.should_skip == 'false'
        name: Define Matrix
        runs-on: ubuntu-latest
        outputs:
            platform-matrix: ${{ steps.matrix.outputs.platform_matrix }}
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
              with:
                  fetch-depth: 0

            - name: Install asdf tools with cache
              uses: camunda/infraex-common-config/./.github/actions/asdf-install-tooling@193a21e1e56c9a65517a822224ac3b4ffa4d6ae4 # 1.5.9

            - name: Define tests matrix
              uses: ./.github/actions/internal-tests-matrix
              id: matrix
              with:
                  ci_matrix_file: ${{ env.CI_MATRIX_FILE }}
                  cluster_name: ${{ inputs.cluster_name }}
                  ref_arch: ${{ inputs.ref-arch }}
                  cluster_prefix: eks-dual-${{ github.event.pull_request.number || '' }}
                  is_schedule: ${{ env.IS_SCHEDULE }}
                  is_renovate_pr: ${{ env.IS_RENOVATE_PR }}

    cluster-creation:
        runs-on: ubuntu-latest
        needs:
            - triage
            - clusters-info
        strategy:
            fail-fast: false
            matrix:
                distro: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).distro }}
                scenario: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).scenario }}
        timeout-minutes: 60
        steps:
            ################## Checkout ##################
            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
            ############# Tool Installation ##############
            - name: Install asdf tools with cache
              uses: camunda/infraex-common-config/./.github/actions/asdf-install-tooling@193a21e1e56c9a65517a822224ac3b4ffa4d6ae4 # 1.5.9
            - name: Configure AWS CLI
              uses: ./.github/actions/aws-configure-cli
              with:
                  vault-addr: ${{ secrets.VAULT_ADDR }}
                  vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
                  vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
                  aws-profile: ${{ env.AWS_PROFILE }}
                  aws-region: ${{ env.AWS_REGION }}

            ################ Env Helper ###################
            - name: Set current target branch
              id: target-branch
              run: |
                  set -euo pipefail
                  TARGET_BRANCH=$(cat .target-branch)
                  echo "TARGET_BRANCH=$TARGET_BRANCH" | tee -a "$GITHUB_OUTPUT"
            - name: Export S3_BACKEND_BUCKET based on matrix
              id: s3_prefix
              run: |
                  set -euo pipefail
                  echo "S3_BACKEND_BUCKET_PREFIX=aws/kubernetes/${{ matrix.scenario.name }}/" | tee -a "$GITHUB_OUTPUT"
            ############# Terraform Apply ################
            # yamllint disable rule:line-length
            - name: Configure Terraform Backend
              run: |
                  cp ${{ github.workspace }}/aws/kubernetes/eks-dual-region/terraform/cluster/test/fixtures/*.tf ${{ github.workspace }}/aws/kubernetes/eks-dual-region/terraform/cluster/
                  echo "TF_CLI_ARGS_init=-backend-config='bucket=${{ env.S3_BACKEND_BUCKET }}' -backend-config='key=${{ steps.s3_prefix.outputs.S3_BACKEND_BUCKET_PREFIX }}${{ steps.target-branch.outputs.TARGET_BRANCH }}/tfstate-${{ matrix.distro.clusterName }}-${{matrix.scenario.shortName }}/cluster.tfstate' -backend-config='region=${{ env.S3_BUCKET_REGION }}' -backend-config='encrypt=true'" >> "$GITHUB_ENV"
            # yamllint enable rule:line-length
            - name: Terratest Terraform Init And Apply
              working-directory: ./aws/kubernetes/eks-dual-region/test/
              timeout-minutes: 46
              env:
                  CLUSTER_NAME: ${{ matrix.distro.clusterName }}-${{matrix.scenario.shortName }}
              run: |
                  go test --count=1 -v -timeout 45m -run TestSetupTerraform
            - name: Remove profile credentials from ~/.aws/credentials
              if: always()
              run: |
                  rm -rf ~/.aws/credentials

    cluster-configuration:
        runs-on: ubuntu-latest
        timeout-minutes: 30
        strategy:
            fail-fast: false
            matrix:
                distro: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).distro }}
                scenario: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).scenario }}
        needs:
            - cluster-creation
            - clusters-info
        steps:
            ################## Checkout ##################
            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
            ############# Tool Installation ##############
            - name: Install asdf tools with cache
              uses: camunda/infraex-common-config/./.github/actions/asdf-install-tooling@193a21e1e56c9a65517a822224ac3b4ffa4d6ae4 # 1.5.9
            - name: Configure AWS CLI
              uses: ./.github/actions/aws-configure-cli
              with:
                  vault-addr: ${{ secrets.VAULT_ADDR }}
                  vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
                  vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
                  aws-profile: ${{ env.AWS_PROFILE }}
                  aws-region: ${{ env.AWS_REGION }}
            ########### KubeConfig Generation ############
            - name: Export Cluster Name
              run: |
                  echo "CLUSTER_NAME=${{ matrix.distro.clusterName }}-${{matrix.scenario.shortName }}" >> "$GITHUB_ENV"
            - name: KubeConfig generation
              working-directory: ./test
              timeout-minutes: 5
              run: |
                  go test --count=1 -v -timeout 4m -run TestAWSKubeConfigCreation
            ########### Parse GHA for versions ###########
            - name: Export GHA for namespace setup
              run: |
                  echo "CLUSTER_1_NAMESPACE_ARR=c8-snap-cluster-1" >> "$GITHUB_ENV"
                  echo "CLUSTER_0_NAMESPACE_ARR=c8-snap-cluster-0" >> "$GITHUB_ENV"
            ################ Env Helper ###################
            - name: Set current target branch
              id: target-branch
              run: |
                  set -euo pipefail
                  TARGET_BRANCH=$(cat .target-branch)
                  echo "TARGET_BRANCH=$TARGET_BRANCH" | tee -a "$GITHUB_OUTPUT"
            - name: Export S3_BACKEND_BUCKET based on matrix
              id: s3_prefix
              run: |
                  set -euo pipefail
                  echo "S3_BACKEND_BUCKET_PREFIX=aws/kubernetes/${{ matrix.scenario.name }}/" | tee -a "$GITHUB_OUTPUT"
            ############ Export S3 credentials ############
            # yamllint disable rule:line-length
            - name: Configure Terraform Backend
              run: |
                  cp ${{ github.workspace }}/aws/kubernetes/eks-dual-region/terraform/cluster/test/fixtures/*.tf ${{ github.workspace }}/aws/kubernetes/eks-dual-region/terraform/cluster/
                  echo "TF_CLI_ARGS_init=-backend-config='bucket=${{ env.S3_BACKEND_BUCKET }}' -backend-config='key=${{ steps.s3_prefix.outputs.S3_BACKEND_BUCKET_PREFIX }}${{ steps.target-branch.outputs.TARGET_BRANCH }}/tfstate-${{ matrix.distro.clusterName }}-${{matrix.scenario.shortName }}/cluster.tfstate' -backend-config='region=${{ env.S3_BUCKET_REGION }}' -backend-config='encrypt=true'" >> "$GITHUB_ENV"
            # yamllint enable rule:line-length
            - name: Get S3 credentials
              id: s3-credentials
              working-directory: ./aws/kubernetes/eks-dual-region/terraform/cluster/
              run: |
                  terraform init
                  # adding mask to treat the value as secret
                  echo "::add-mask::$(terraform output -raw s3_aws_access_key)"
                  echo "::add-mask::$(terraform output -raw s3_aws_secret_access_key)"
                  echo "AWS_ACCESS_KEY_ES=$(terraform output -raw s3_aws_access_key)" >> "$GITHUB_OUTPUT"
                  echo "AWS_SECRET_ACCESS_KEY_ES=$(terraform output -raw s3_aws_secret_access_key)" >> "$GITHUB_OUTPUT"
            - name: Create all required namespaces and secrets
              timeout-minutes: 10
              working-directory: ./aws/kubernetes/eks-dual-region/test/
              env:
                  AWS_ACCESS_KEY_ES: ${{ steps.s3-credentials.outputs.AWS_ACCESS_KEY_ES }}
                  AWS_SECRET_ACCESS_KEY_ES: ${{ steps.s3-credentials.outputs.AWS_SECRET_ACCESS_KEY_ES }}
              run: |
                  go test --count=1 -v -timeout 9m -run TestClusterPrerequisites
            ########### Namespace and DNS setup #########
            - name: Do the DNS chaining for all required namespaces
              working-directory: ./aws/kubernetes/eks-dual-region/test/
              timeout-minutes: 15
              env:
                  # Pick a known namespace for cross cluster testing
                  CLUSTER_0_NAMESPACE: snapshot-cluster-0
                  CLUSTER_0_NAMESPACE_FAILOVER: snapshot-cluster-0-failover
                  CLUSTER_1_NAMESPACE: snapshot-cluster-1
                  CLUSTER_1_NAMESPACE_FAILOVER: snapshot-cluster-1-failover
              run: |
                  go test --count=1 -v -timeout 44m -run TestAWSDNSChaining
            - name: KubeConfig Removal
              working-directory: ./aws/kubernetes/eks-dual-region/test/
              if: always()
              timeout-minutes: 5
              run: |
                  go test --count=1 -v -timeout 4m -run TestAWSKubeConfigRemoval
            - name: Remove profile credentials from ~/.aws/credentials
              if: always()
              run: |
                  rm -rf ~/.aws/credentials

    operational-procedure:
        needs:
            - cluster-creation
            - cluster-configuration
            - clusters-info
        strategy:
            fail-fast: false
            matrix:
                distro: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).distro }}
                scenario: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).scenario }}
        uses: ./.github/workflows/reuseable_aws_operational_procedure.yml
        with:
            cluster-name: ${{ matrix.distro.clusterName }}-${{matrix.scenario.shortName }}
        secrets: inherit

    tf-teardown:
        runs-on: ubuntu-latest
        timeout-minutes: 60
        needs:
            - operational-procedure
            - cluster-creation
            - clusters-info
        strategy:
            fail-fast: false
            matrix:
                distro: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).distro }}
                scenario: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).scenario }}
        steps:
            ################## Checkout ##################
            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
            ############# Tool Installation ##############
            - name: Install asdf tools with cache
              uses: camunda/infraex-common-config/./.github/actions/asdf-install-tooling@193a21e1e56c9a65517a822224ac3b4ffa4d6ae4 # 1.5.9
            - name: Configure AWS CLI
              uses: ./.github/actions/aws-configure-cli
              with:
                  vault-addr: ${{ secrets.VAULT_ADDR }}
                  vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
                  vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
                  aws-profile: ${{ env.AWS_PROFILE }}
                  aws-region: ${{ env.AWS_REGION }}
            ################ Env Helper ###################
            - name: Set current target branch
              id: target-branch
              run: |
                  set -euo pipefail
                  TARGET_BRANCH=$(cat .target-branch)
                  echo "TARGET_BRANCH=$TARGET_BRANCH" | tee -a "$GITHUB_OUTPUT"
            - name: Export S3_BACKEND_BUCKET based on matrix
              id: s3_prefix
              run: |
                  set -euo pipefail
                  echo "S3_BACKEND_BUCKET_PREFIX=aws/kubernetes/${{ matrix.scenario.name }}/" | tee -a "$GITHUB_OUTPUT"
            ########### KubeConfig Generation ############
            - name: Export Cluster Name
              run: |
                  echo "CLUSTER_NAME=${{ matrix.distro.clusterName }}-${{matrix.scenario.shortName }}" >> "$GITHUB_ENV"
            - name: KubeConfig generation
              working-directory: ./aws/kubernetes/eks-dual-region/test/
              timeout-minutes: 5
              run: |
                  go test --count=1 -v -timeout 4m -run TestAWSKubeConfigCreation
    ########### Load Balancer Removal ############
            - name: Delete LBs to unblock teardown
              working-directory: ./aws/kubernetes/eks-dual-region/test/
              timeout-minutes: 5
              run: |
                  go test --count=1 -v -timeout 4m -run TestClusterCleanup
    ############# Terratest Teardown #############
            # yamllint disable rule:line-length
            - name: Configure Terraform Backend
              run: |
                  cp ${{ github.workspace }}/test/fixtures/*.tf ${{ github.workspace }}/aws/dual-region/terraform/
                  echo "TF_CLI_ARGS_init=-backend-config='bucket=${{ env.S3_BACKEND_BUCKET }}' -backend-config='key=state/${{ env.CLUSTER_NAME }}/terraform.tfstate' -backend-config='region=${{ env.S3_BUCKET_REGION }}' -backend-config='encrypt=true'" >> "$GITHUB_ENV"
            # yamllint enable rule:line-length
            - name: Terraform Destroy
              id: terraform-destroy
              working-directory: ./aws/kubernetes/eks-dual-region/test/
              if: always()
              timeout-minutes: 46
              run: |
                  go test --count=1 -v -timeout 45m -run TestTeardownTerraform
            - name: KubeConfig Removal
              working-directory: ./aws/kubernetes/eks-dual-region/test/
              if: always()
              timeout-minutes: 5
              run: |
                  go test --count=1 -v -timeout 4m -run TestAWSKubeConfigRemoval
            - name: Cleanup S3 state bucket
              if: always() && steps.terraform-destroy.outcome == 'success'
              run: |
                  aws s3 rm "s3://${{ env.S3_BACKEND_BUCKET }}/${{ steps.s3_prefix.outputs.S3_BACKEND_BUCKET_PREFIX }}${{ steps.target-branch.outputs.TARGET_BRANCH }}/tfstate-${{ matrix.distro.clusterName }}-${{matrix.scenario.shortName }}/cluster.tfstate"
            - name: Remove profile credentials from ~/.aws/credentials
              if: always()
              run: |
                  rm -rf ~/.aws/credentials

    notify-on-failure:
        runs-on: ubuntu-latest
        if: github.event_name == 'schedule' && failure()
        needs:
            - cluster-creation
            - cluster-configuration
            - operational-procedure
            - tf-teardown
        steps:
            - name: Notify in Slack in case of failure
              id: slack-notification
              uses: camunda/infraex-common-config/.github/actions/report-failure-on-slack@193a21e1e56c9a65517a822224ac3b4ffa4d6ae4 # 1.5.9
              with:
                  vault_addr: ${{ secrets.VAULT_ADDR }}
                  vault_role_id: ${{ secrets.VAULT_ROLE_ID }}
                  vault_secret_id: ${{ secrets.VAULT_SECRET_ID }}
