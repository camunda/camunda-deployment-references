---
name: Tests - Integration - Generic Migration from Bitnami

permissions:
    contents: read
    pull-requests: write

on:
    schedule:
        - cron: 0 3 * * 2 # Runs at 3 AM on Tuesday (after operator-based tests on Monday)
    pull_request:
        paths:
            - .github/workflows/generic_kubernetes_migration_test.yml
            - .github/workflows-config/generic-kubernetes-migration-from-bitnami/test_matrix.yml
            - .tool-versions
            - generic/kubernetes/migration/**
            - generic/kubernetes/operator-based/**
            - local/kubernetes/kind-single-region/**
            - .github/actions/internal-apply-skip-label/**
            - .github/actions/internal-tests-matrix/**
            - .github/actions/internal-clean-namespace/**

    workflow_dispatch:
        inputs:
            enable_tests:
                description: Whether to enable the tests.
                type: boolean
                default: true
            migration_component:
                description: |
                    Which component to test migration for.
                    Valid values are 'full', 'orchestration', 'identity', 'keycloak', 'webmodeler'.
                required: false
                type: string
                default: full

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: false

env:
    IS_SCHEDULE: ${{ (contains(github.head_ref, 'schedules/') || github.event_name == 'schedule') && 'true' || 'false' }}
    IS_RENOVATE_PR: ${{ github.event_name == 'pull_request' && github.event.pull_request.user.login == 'renovate[bot]' }}

    CI_MATRIX_FILE: .github/workflows-config/generic-kubernetes-migration-from-bitnami/test_matrix.yml

    TESTS_ENABLED: ${{ github.event.inputs.enable_tests || 'true' }}

    # renovate: datasource=github-tags depName=camunda/camunda-platform-helm
    TESTS_CAMUNDA_HELM_CHART_REPO_REF: main
    TESTS_CAMUNDA_HELM_CHART_REPO_PATH: ./.camunda_helm_repo

jobs:
    triage:
        runs-on: ubuntu-latest
        outputs:
            should_skip: ${{ steps.skip_check.outputs.should_skip }}
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
            - name: Check labels
              id: skip_check
              uses: ./.github/actions/internal-triage-skip

    clusters-info:
        needs:
            - triage
        if: needs.triage.outputs.should_skip == 'false'
        name: Define Matrix
        runs-on: ubuntu-latest
        outputs:
            platform-matrix: ${{ steps.matrix.outputs.platform_matrix }}
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
              with:
                  fetch-depth: 0

            - name: Install asdf tools with cache
              uses: camunda/infraex-common-config/./.github/actions/asdf-install-tooling@b52f5bb65b5bb9e0b0458c46b8671bf1fe9a907f # 1.5.7

            - name: Define tests matrix
              uses: ./.github/actions/internal-tests-matrix
              id: matrix
              with:
                  ci_matrix_file: ${{ env.CI_MATRIX_FILE }}
                  cluster_prefix: kind-migr
                  ref_arch: migration-from-bitnami
                  is_schedule: ${{ env.IS_SCHEDULE }}
                  is_renovate_pr: ${{ env.IS_RENOVATE_PR }}

    migration-tests:
        name: Run migration tests - ${{ matrix.distro.name }} - ${{ matrix.scenario.name }} - ${{ matrix.declination.name }}
        needs:
            - triage
            - clusters-info
        if: needs.triage.outputs.should_skip == 'false'
        runs-on: aws-core-16-default
        timeout-minutes: 60
        strategy:
            fail-fast: false
            matrix:
                distro: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).distro }}
                scenario: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).scenario }}
                declination: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).declination }}
        env:
            CLUSTER_NAME: camunda-platform-local
            CAMUNDA_NAMESPACE: camunda
            CAMUNDA_RELEASE_NAME: camunda
            REF_ARCH_PATH: local/kubernetes/kind-single-region
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

            - name: Install asdf tools with cache
              uses: camunda/infraex-common-config/./.github/actions/asdf-install-tooling@b52f5bb65b5bb9e0b0458c46b8671bf1fe9a907f # 1.5.7

            - name: Install envsubst
              run: |
                  sudo apt-get update -qq
                  sudo apt-get install -y -qq gettext-base

            - name: Import Secrets
              id: secrets
              uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3
              with:
                  url: ${{ secrets.VAULT_ADDR }}
                  method: approle
                  roleId: ${{ secrets.VAULT_ROLE_ID }}
                  secretId: ${{ secrets.VAULT_SECRET_ID }}
                  exportEnv: false
                  secrets: |
                      secret/data/products/infrastructure-experience/ci/common DOCKERHUB_USER;
                      secret/data/products/infrastructure-experience/ci/common DOCKERHUB_PASSWORD;
                      secret/data/products/infrastructure-experience/ci/common MACHINE_USR;
                      secret/data/products/infrastructure-experience/ci/common MACHINE_PWD;

            # =================================================================
            # Create Kind cluster
            # =================================================================
            - name: Create Kind cluster
              run: |
                  set -euo pipefail
                  kind create cluster --config generic/kubernetes/migration/tests/kind-cluster-config.yaml
                  kubectl cluster-info --context kind-camunda-platform-local
                  kubectl wait --for=condition=Ready nodes --all --timeout=300s
                  kubectl get nodes -o wide
                  kubectl create namespace camunda --dry-run=client -o yaml | kubectl apply -f -

            - name: Create pull secrets
              run: |
                  set -euo pipefail
                  kubectl create namespace "${{ env.CAMUNDA_NAMESPACE }}" --dry-run=client -o yaml | kubectl apply -f -
                  kubectl create secret docker-registry index-docker-io \
                      --docker-server=index.docker.io \
                      --docker-username="${{ steps.secrets.outputs.DOCKERHUB_USER }}" \
                      --docker-password="${{ steps.secrets.outputs.DOCKERHUB_PASSWORD }}" \
                      --namespace="${{ env.CAMUNDA_NAMESPACE }}"
                  kubectl create secret docker-registry registry-camunda-cloud \
                      --docker-server=registry.camunda.cloud \
                      --docker-username="${{ steps.secrets.outputs.MACHINE_USR }}" \
                      --docker-password="${{ steps.secrets.outputs.MACHINE_PWD }}" \
                      --namespace="${{ env.CAMUNDA_NAMESPACE }}"

            # =================================================================
            # Domain mode setup (ingress, TLS, DNS)
            # =================================================================
            - name: Deploy Ingress NGINX
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: ./procedure/ingress-nginx-deploy.sh

            - name: Configure CoreDNS for domain resolution
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: ./procedure/coredns-config.sh

            - name: Generate TLS certificates
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: ./procedure/certs-generate.sh

            - name: Create TLS secret
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: ./procedure/certs-create-secret.sh

            - name: Create CA ConfigMap
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: ./procedure/certs-create-ca-configmap.sh

            - name: Set domain environment
              run: |
                  set -euo pipefail
                  if [[ "${{ matrix.declination.use_tls }}" == "true" ]]; then
                      echo "CAMUNDA_DOMAIN=camunda.example.com" | tee -a "$GITHUB_ENV"
                  fi

            # =================================================================
            # STEP 1: Deploy Camunda with Bitnami sub-charts (SOURCE)
            # =================================================================
            - name: Deploy Camunda with Bitnami sub-charts
              timeout-minutes: 20
              run: |
                  set -euo pipefail

                  echo "Adding Camunda Helm repository..."
                  helm repo add camunda https://helm.camunda.io
                  helm repo update

                  HELM_ARGS=(
                      --namespace "${{ env.CAMUNDA_NAMESPACE }}"
                      --values generic/kubernetes/migration/tests/bitnami-values.yml
                      --timeout 20m
                      --wait
                  )

                  # Add domain overlay values for TLS/Ingress mode
                  if [[ "${{ matrix.declination.use_tls }}" == "true" ]]; then
                      echo "Installing Camunda Platform with Bitnami sub-charts (domain mode)..."
                      HELM_ARGS+=(--values generic/kubernetes/migration/tests/bitnami-values-domain.yml)
                  else
                      echo "Installing Camunda Platform with Bitnami sub-charts (no-domain mode)..."
                  fi

                  helm install camunda camunda/camunda-platform "${HELM_ARGS[@]}"

                  echo "Camunda with Bitnami sub-charts deployed successfully"

            - name: Wait for Bitnami deployment to be ready
              timeout-minutes: 15
              run: |
                  set -euo pipefail

                  echo "Waiting for all pods to be ready..."
                  sleep 60

                  kubectl get pods -n "${{ env.CAMUNDA_NAMESPACE }}"

                  # Wait for key resources (8.8+: zeebe StatefulSet = orchestration, includes gateway/operate/tasklist)
                  kubectl rollout status statefulset/camunda-zeebe -n "${{ env.CAMUNDA_NAMESPACE }}" --timeout=300s || true
                  kubectl rollout status deployment/camunda-identity -n "${{ env.CAMUNDA_NAMESPACE }}" --timeout=300s || true
                  kubectl rollout status deployment/camunda-connectors -n "${{ env.CAMUNDA_NAMESPACE }}" --timeout=300s || true

                  echo "Bitnami deployment ready"

            # =================================================================
            # STEP 1.5: Generate Test Data for Migration Validation
            # =================================================================
            - name: Seed test data (Zeebe processes, Keycloak user/client, WebModeler project)
              timeout-minutes: 15
              run: |
                  set -euo pipefail

                  echo "Seeding migration test data across all components..."

                  kubectl apply -n "${{ env.CAMUNDA_NAMESPACE }}" \
                      -f generic/kubernetes/migration/tests/seed-test-data-job.yml

                  echo "Waiting for seed job to complete..."
                  kubectl wait --for=condition=complete job/seed-test-data \
                      -n "${{ env.CAMUNDA_NAMESPACE }}" --timeout=600s || {
                      echo "Seed job did not complete in time. Logs:"
                      kubectl logs job/seed-test-data -n "${{ env.CAMUNDA_NAMESPACE }}" --tail=100 || true
                      exit 1
                  }

                  echo "Seed job logs:"
                  kubectl logs job/seed-test-data -n "${{ env.CAMUNDA_NAMESPACE }}" --tail=50 || true

                  echo "Seeding completed"

            - name: Wait for data to propagate to Elasticsearch
              timeout-minutes: 5
              run: |
                  set -euo pipefail

                  echo "Waiting for data to propagate to Elasticsearch..."
                  sleep 60

                  ES_POD=$(kubectl get pods -n "${{ env.CAMUNDA_NAMESPACE }}" \
                      -l "app=elasticsearch" -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")

                  if [[ -n "$ES_POD" ]]; then
                      echo "Checking Elasticsearch indices..."
                      kubectl exec -n "${{ env.CAMUNDA_NAMESPACE }}" "$ES_POD" -- \
                          curl -s "localhost:9200/_cat/indices?v" | grep -E "(operate|tasklist|optimize|connectors)" || true

                      INSTANCE_COUNT=$(kubectl exec -n "${{ env.CAMUNDA_NAMESPACE }}" "$ES_POD" -- \
                          curl -s "localhost:9200/operate-list-view-*/_count" 2>/dev/null | jq -r '.count // 0' || echo "0")
                      echo "Found ${INSTANCE_COUNT} process instances in Elasticsearch"
                  fi

                  echo "Data propagation complete"

            # =================================================================
            # STEP 2: Run Migration (4 phases)
            # =================================================================
            - name: Set migration environment variables
              run: |
                  set -euo pipefail

                  {
                    echo "NAMESPACE=${{ env.CAMUNDA_NAMESPACE }}"
                    echo "CAMUNDA_RELEASE_NAME=camunda"
                    echo "BACKUP_PVC=migration-backup-pvc"
                    echo "BACKUP_STORAGE_SIZE=10Gi"
                    echo "MIGRATE_IDENTITY=true"
                    echo "MIGRATE_KEYCLOAK=true"
                    echo "MIGRATE_WEBMODELER=true"
                    echo "MIGRATE_ELASTICSEARCH=true"
                    echo "PG_TARGET_MODE=operator"
                    echo "ES_TARGET_MODE=operator"
                  } >> "$GITHUB_ENV"

            # --- Phase 1: Deploy Targets (no downtime) ---
            - name: Phase 1 - Deploy target infrastructure
              timeout-minutes: 20
              working-directory: ./generic/kubernetes/migration/
              run: |
                  set -euo pipefail
                  source ./env.sh
                  ./1-deploy-targets.sh --yes

            # --- Phase 2: Backup (no downtime) ---
            - name: Phase 2 - Initial backup (warm, no downtime)
              timeout-minutes: 15
              working-directory: ./generic/kubernetes/migration/
              run: |
                  set -euo pipefail
                  source ./env.sh
                  ./2-backup.sh

            # --- Phase 3: Cutover (downtime window) ---
            - name: Phase 3 - Cutover (freeze, backup, restore, switch)
              timeout-minutes: 20
              working-directory: ./generic/kubernetes/migration/
              run: |
                  set -euo pipefail
                  source ./env.sh
                  ./3-cutover.sh --yes

            # --- Phase 4: Validate ---
            - name: Phase 4 - Validate migration
              timeout-minutes: 10
              working-directory: ./generic/kubernetes/migration/
              run: |
                  set -euo pipefail
                  source ./env.sh
                  ./4-validate.sh

            # =================================================================
            # STEP 3: Verify Seeded Test Data Post-Migration
            # =================================================================
            - name: Verify test data survived migration
              timeout-minutes: 15
              run: |
                  set -euo pipefail

                  echo "Verifying seeded test data after migration..."

                  kubectl apply -n "${{ env.CAMUNDA_NAMESPACE }}" \
                      -f generic/kubernetes/migration/tests/verify-test-data-job.yml

                  echo "Waiting for verify job to complete..."
                  kubectl wait --for=condition=complete job/verify-test-data \
                      -n "${{ env.CAMUNDA_NAMESPACE }}" --timeout=600s || {
                      echo "Verify job did not complete in time. Logs:"
                      kubectl logs job/verify-test-data -n "${{ env.CAMUNDA_NAMESPACE }}" --tail=100 || true
                      exit 1
                  }

                  echo "Verification logs:"
                  kubectl logs job/verify-test-data -n "${{ env.CAMUNDA_NAMESPACE }}"

                  # Check exit code: the job script exits with the number of failures
                  VERIFY_STATUS=$(kubectl get job verify-test-data -n "${{ env.CAMUNDA_NAMESPACE }}" \
                      -o jsonpath='{.status.succeeded}' || echo "0")
                  if [[ "$VERIFY_STATUS" == "1" ]]; then
                      echo "All migration verification checks passed!"
                  else
                      echo "Migration verification FAILED"
                      exit 1
                  fi

            # =================================================================
            # Debug & Cleanup
            # =================================================================
            - name: Setup tmate session for debugging
              if: failure()
              uses: mxschmitt/action-tmate@v3
              with:
                  detached: true
              timeout-minutes: 60

            - name: Get failed Pods info
              if: failure()
              uses: ./.github/actions/internal-debug-failed-pods
              with:
                  namespace: ${{ env.CAMUNDA_NAMESPACE }}
                  artifact-suffix: ${{ matrix.distro.name }}-${{ matrix.scenario.name }}-${{ matrix.declination.name }}

            - name: Cleanup Kind cluster
              if: always()
              run: |
                  set -euo pipefail
                  echo "Cleaning up Kind cluster: ${{ env.CLUSTER_NAME }}"
                  kind delete cluster --name "${{ env.CLUSTER_NAME }}" || true

    report-success:
        name: Report success
        runs-on: ubuntu-latest
        needs:
            - migration-tests
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

            - name: Prevent other runs for renovate
              if: ${{ env.IS_RENOVATE_PR == 'true' }}
              env:
                  GH_TOKEN: ${{ github.token }}
              uses: ./.github/actions/internal-apply-skip-label

    report-failures:
        name: Report failures
        if: failure()
        runs-on: ubuntu-latest
        needs:
            - report-success
        steps:
            - name: Notify in Slack in case of failure
              id: slack-notification
              if: ${{ env.IS_SCHEDULE == 'true' }}
              uses: camunda/infraex-common-config/.github/actions/report-failure-on-slack@b52f5bb65b5bb9e0b0458c46b8671bf1fe9a907f # 1.5.7
              with:
                  vault_addr: ${{ secrets.VAULT_ADDR }}
                  vault_role_id: ${{ secrets.VAULT_ROLE_ID }}
                  vault_secret_id: ${{ secrets.VAULT_SECRET_ID }}
