---
name: Tests - Integration - Local Kubernetes Kind Single Region
permissions:
    contents: read
    pull-requests: write
on:
    schedule:
        - cron: 0 4 * * 3
    pull_request: {}
    workflow_dispatch:
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: false
env:
    REF_ARCH_PATH: local/kubernetes/kind-single-region
    IS_SCHEDULE: ${{ contains(github.head_ref, 'schedules/') || github.event_name == 'schedule' && 'true' || 'false' }}
    IS_RENOVATE_PR: ${{ github.event_name == 'pull_request' && github.event.pull_request.user.login == 'renovate[bot]' }}
    CI_MATRIX_FILE: .github/workflows-config/local-kubernetes-kind-single-region/test_matrix.yml
    TESTS_ENABLED: 'true'
    TESTS_CAMUNDA_HELM_CHART_REPO_REF: fix-venom-8-8
    TESTS_CAMUNDA_HELM_CHART_REPO_PATH: ./.camunda_helm_repo
jobs:
    triage:
        runs-on: ubuntu-latest
        outputs:
            should_skip: ${{ steps.skip_check.outputs.should_skip }}
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
            - name: Check labels
              id: skip_check
              uses: ./.github/actions/internal-triage-skip
    clusters-info:
        needs: triage
        if: needs.triage.outputs.should_skip == 'false'
        name: Define Matrix
        runs-on: ubuntu-latest
        outputs:
            platform-matrix: ${{ steps.matrix.outputs.platform_matrix }}
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
            - name: Install asdf tools with cache
              uses: camunda/infraex-common-config/./.github/actions/asdf-install-tooling@193a21e1e56c9a65517a822224ac3b4ffa4d6ae4
            - name: Define tests matrix
              uses: ./.github/actions/internal-tests-matrix
              id: matrix
              with:
                  ci_matrix_file: ${{ env.CI_MATRIX_FILE }}
                  cluster_prefix: kind-${{ github.event.pull_request.number || '' }}
                  is_schedule: ${{ env.IS_SCHEDULE }}
                  is_renovate_pr: ${{ env.IS_RENOVATE_PR }}
    integration-tests:
        name: Test ${{ matrix.distro.name }} - ${{ matrix.declination.name }}
        needs:
            - triage
            - clusters-info
        if: needs.triage.outputs.should_skip == 'false'
        runs-on: aws-core-8-default
        timeout-minutes: 45
        strategy:
            fail-fast: false
            matrix:
                distro: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).distro }}
                scenario: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).scenario }}
                declination: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).declination }}
        env:
            CLUSTER_NAME: camunda-platform-local
            CAMUNDA_NAMESPACE: camunda
            CAMUNDA_RELEASE_NAME: camunda
            TEST_CLUSTER_TYPE: kubernetes
        steps:
            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
            - name: Install asdf tools with cache
              uses: camunda/infraex-common-config/./.github/actions/asdf-install-tooling@193a21e1e56c9a65517a822224ac3b4ffa4d6ae4
            - name: Import Secrets
              id: secrets
              uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b
              with:
                  url: ${{ secrets.VAULT_ADDR }}
                  method: approle
                  roleId: ${{ secrets.VAULT_ROLE_ID }}
                  secretId: ${{ secrets.VAULT_SECRET_ID }}
                  exportEnv: false
                  secrets: |
                      secret/data/products/infrastructure-experience/ci/common DOCKERHUB_USER;
                      secret/data/products/infrastructure-experience/ci/common DOCKERHUB_PASSWORD;
                      secret/data/products/infrastructure-experience/ci/common CI_CAMUNDA_USER_TEST_CLIENT_ID;
                      secret/data/products/infrastructure-experience/ci/common CI_CAMUNDA_USER_TEST_CLIENT_SECRET;
            - name: Create Kind cluster
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: ./procedure/cluster-create.sh
            - name: Deploy Ingress NGINX
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: ./procedure/ingress-nginx-deploy.sh
            - name: Configure CoreDNS
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  ./procedure/coredns-config.sh
            - name: Generate TLS certificates
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  ./procedure/certs-generate.sh
            - name: Create TLS secret
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  ./procedure/certs-create-secret.sh
            - name: Create CA ConfigMap
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  ./procedure/certs-create-ca-configmap.sh
            - name: Create Docker Hub pull secret
              run: |
                  set -euo pipefail

                  # Create the pull secret to avoid Docker Hub rate limit
                  kubectl create secret docker-registry index-docker-io \
                      --docker-server=index.docker.io \
                      --docker-username="${{ steps.secrets.outputs.DOCKERHUB_USER }}" \
                      --docker-password="${{ steps.secrets.outputs.DOCKERHUB_PASSWORD }}" \
                      --namespace="${{ env.CAMUNDA_NAMESPACE }}"
            - name: Deploy Camunda (domain mode)
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  # Apply registry configuration to avoid Docker Hub rate limit
                  yq ". *+ load(\"../../../generic/kubernetes/single-region/tests/helm-values/registry.yml\")" \
                    helm-values/values-domain.yml > helm-values/values-domain.yml.tmp
                  mv helm-values/values-domain.yml.tmp helm-values/values-domain.yml

                  ./procedure/camunda-deploy-domain.sh
            - name: Deploy Camunda (no-domain mode)
              if: ${{ !matrix.declination.use_tls }}
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  # Apply registry configuration to avoid Docker Hub rate limit
                  yq ". *+ load(\"../../../generic/kubernetes/single-region/tests/helm-values/registry.yml\")" \
                    helm-values/values-no-domain.yml > helm-values/values-no-domain.yml.tmp
                  mv helm-values/values-no-domain.yml.tmp helm-values/values-no-domain.yml

                  ./procedure/camunda-deploy-no-domain.sh
            - name: Wait for Camunda deployment
              timeout-minutes: 10
              env:
                  CAMUNDA_NAMESPACE: ${{ env.CAMUNDA_NAMESPACE }}
              run: ./generic/kubernetes/single-region/procedure/check-deployment-ready.sh
            - name: âœ… Deployment verification successful
              run: |
                  set -euo pipefail

                  echo "=== Deployment Successful ==="
                  echo "Camunda Platform has been successfully deployed and all pods are ready."

                  echo ""
                  echo "=== Helm Release ==="
                  helm list -n "${{ env.CAMUNDA_NAMESPACE }}"

                  echo ""
                  echo "=== All Resources ==="
                  kubectl get all -n "${{ env.CAMUNDA_NAMESPACE }}"
            - name: Set Camunda domain environment variables
              run: |
                  set -euo pipefail

                  if [[ "${{ matrix.declination.use_tls }}" == "true" ]]; then
                      echo "CAMUNDA_DOMAIN=camunda.example.com" | tee -a "$GITHUB_ENV"
                      echo "CAMUNDA_GRPC_DOMAIN=zeebe-camunda.example.com:443" | tee -a "$GITHUB_ENV"
                  else
                      echo "CAMUNDA_DOMAIN=" | tee -a "$GITHUB_ENV"
                      echo "CAMUNDA_GRPC_DOMAIN=" | tee -a "$GITHUB_ENV"
                  fi
            - name: Set current Camunda version
              id: camunda-version
              run: |
                  set -euo pipefail

                  CAMUNDA_VERSION=$(cat .camunda-version)
                  echo "CAMUNDA_VERSION=$CAMUNDA_VERSION" | tee -a "$GITHUB_OUTPUT"
            - name: Extract auto-generated credentials from Helm deployment
              id: local-credentials
              run: "set -euo pipefail\n\necho \"\U0001F4E6 Extracting auto-generated credentials from camunda-credentials secret...\"\n\n# The Helm chart\
                  \ auto-generates an 'orchestration' client that can be used for M2M authentication\n# Client ID is 'orchestration' and secret is stored\
                  \ in identity-orchestration-client-token\nLOCAL_CLIENT_ID=\"orchestration\"\nLOCAL_CLIENT_SECRET=$(kubectl get secret camunda-credentials\
                  \ -n \"${{ env.CAMUNDA_NAMESPACE }}\" \\\n  -o jsonpath='{.data.identity-orchestration-client-token}' | base64 -d)\n\nif [[ -z \"$LOCAL_CLIENT_SECRET\"\
                  \ ]]; then\n  echo \"âš ï¸ Could not extract orchestration client secret, tests requiring auth will be skipped\"\n  echo \"LOCAL_CLIENT_ID=\"\
                  \ | tee -a \"$GITHUB_OUTPUT\"\n  echo \"LOCAL_CLIENT_SECRET=\" | tee -a \"$GITHUB_OUTPUT\"\nelse\n  echo \"âœ… Successfully extracted orchestration\
                  \ client credentials\"\n  echo \"LOCAL_CLIENT_ID=$LOCAL_CLIENT_ID\" | tee -a \"$GITHUB_OUTPUT\"\n  # Don't print secret to logs\n  echo\
                  \ \"LOCAL_CLIENT_SECRET=$LOCAL_CLIENT_SECRET\" >> \"$GITHUB_OUTPUT\"\nfi\n"
            - name: ðŸ§ª Run C8-SM-CHECKS deployment and connectivity tests
              if: env.TESTS_ENABLED == 'true'
              timeout-minutes: 15
              uses: ./.github/actions/internal-camunda-chart-tests
              with:
                  secrets: ${{ toJSON(secrets) }}
                  camunda-version: ${{ steps.camunda-version.outputs.CAMUNDA_VERSION }}
                  camunda-domain: ${{ env.CAMUNDA_DOMAIN }}
                  camunda-domain-grpc: ${{ env.CAMUNDA_GRPC_DOMAIN }}
                  webmodeler-enabled: 'true'
                  console-enabled: 'true'
                  test-namespace: ${{ env.CAMUNDA_NAMESPACE }}
                  test-cluster-type: ${{ env.TEST_CLUSTER_TYPE }}
                  test-release-name: ${{ env.CAMUNDA_RELEASE_NAME }}
                  test-client-id: ${{ steps.local-credentials.outputs.LOCAL_CLIENT_ID }}
                  test-client-secret: ${{ steps.local-credentials.outputs.LOCAL_CLIENT_SECRET }}
                  enable-helm-chart-tests: 'false'
                  enable-zeebe-client-tests: 'false'
                  enable-c8sm-deployment-check: 'true'
                  enable-c8sm-connectivity-check: 'true'
                  skip-c8sm-connectivity-ingress-class-check: 'false'
                  enable-c8sm-irsa-check: 'false'
                  enable-c8sm-zeebe-token-check: ${{ matrix.declination.use_tls && steps.local-credentials.outputs.LOCAL_CLIENT_SECRET != '' && 'true' ||
                      'false' }}
                  enable-c8sm-zeebe-connectivity-check: ${{ matrix.declination.use_tls && steps.local-credentials.outputs.LOCAL_CLIENT_SECRET != '' && 'true'
                      || 'false' }}
                  local-domain-mode: ${{ matrix.declination.use_tls && 'true' || 'false' }}
            - name: ðŸ”¬ðŸš¨ Debug - Show pod details on failure
              if: failure()
              run: |
                  set -euo pipefail

                  echo "========================================"
                  echo "=== CLUSTER STATE DEBUG INFORMATION ==="
                  echo "========================================"

                  echo ""
                  echo "=== Node Status ==="
                  kubectl get nodes -o wide
                  kubectl describe nodes | grep -A 10 "Allocated resources"

                  echo ""
                  echo "=== Pod Status (All Namespaces) ==="
                  kubectl get pods -A -o wide

                  echo ""
                  echo "=== Pod Status (Camunda Namespace) ==="
                  kubectl get pods -n "${{ env.CAMUNDA_NAMESPACE }}" -o wide

                  echo ""
                  echo "=== PVC Status ==="
                  kubectl get pvc -n "${{ env.CAMUNDA_NAMESPACE }}" -o wide || true

                  echo ""
                  echo "=== PV Status ==="
                  kubectl get pv -o wide || true

                  echo ""
                  echo "=== Services ==="
                  kubectl get svc -n "${{ env.CAMUNDA_NAMESPACE }}" -o wide

                  echo ""
                  echo "=== ConfigMaps ==="
                  kubectl get configmaps -n "${{ env.CAMUNDA_NAMESPACE }}"

                  echo ""
                  echo "=== Ingress ==="
                  kubectl get ingress -n "${{ env.CAMUNDA_NAMESPACE }}" -o wide || true

                  echo ""
                  echo "=== Events (sorted by time, last 100) ==="
                  kubectl get events -n "${{ env.CAMUNDA_NAMESPACE }}" --sort-by='.lastTimestamp' | tail -100

                  echo ""
                  echo "========================================"
                  echo "=== DETAILED POD ANALYSIS ==="
                  echo "========================================"

                  echo ""
                  echo "=== All Pods Full Description ==="
                  kubectl get pods -n "${{ env.CAMUNDA_NAMESPACE }}" --no-headers | awk '{print $1}' | while read -r pod; do
                      if [[ -n "$pod" ]]; then
                          echo ""
                          echo "############################################"
                          echo "### Pod: $pod"
                          echo "############################################"
                          kubectl describe pod "$pod" -n "${{ env.CAMUNDA_NAMESPACE }}"
                      fi
                  done

                  echo ""
                  echo "========================================"
                  echo "=== POD LOGS (last 200 lines each) ==="
                  echo "========================================"

                  kubectl get pods -n "${{ env.CAMUNDA_NAMESPACE }}" --no-headers | awk '{print $1}' | while read -r pod; do
                      if [[ -n "$pod" ]]; then
                          echo ""
                          echo "############################################"
                          echo "### Logs: $pod"
                          echo "############################################"
                          kubectl logs "$pod" -n "${{ env.CAMUNDA_NAMESPACE }}" --all-containers --tail=200 || true
                          echo ""
                          echo "### Previous Logs (if container restarted): $pod"
                          kubectl logs "$pod" -n "${{ env.CAMUNDA_NAMESPACE }}" --all-containers --tail=100 --previous 2>/dev/null || echo "No previous logs available"
                      fi
                  done

                  echo ""
                  echo "========================================"
                  echo "=== RESOURCE USAGE ==="
                  echo "========================================"
                  kubectl top pods -n "${{ env.CAMUNDA_NAMESPACE }}" 2>/dev/null || echo "Metrics server not available"
                  kubectl top nodes 2>/dev/null || echo "Metrics server not available"
            - name: ðŸ”¬ðŸš¨ Debug - Show Helm status on failure
              if: failure()
              run: |
                  set -euo pipefail

                  echo "========================================"
                  echo "=== HELM DEBUG INFORMATION ==="
                  echo "========================================"

                  echo ""
                  echo "=== Helm Releases ==="
                  helm list -n "${{ env.CAMUNDA_NAMESPACE }}" -a

                  echo ""
                  echo "=== Helm Status ==="
                  helm status "${{ env.CAMUNDA_RELEASE_NAME }}" -n "${{ env.CAMUNDA_NAMESPACE }}" || true

                  echo ""
                  echo "=== Helm History ==="
                  helm history "${{ env.CAMUNDA_RELEASE_NAME }}" -n "${{ env.CAMUNDA_NAMESPACE }}" || true

                  echo ""
                  echo "=== Helm Values (computed) ==="
                  helm get values "${{ env.CAMUNDA_RELEASE_NAME }}" -n "${{ env.CAMUNDA_NAMESPACE }}" --all || true

                  echo ""
                  echo "=== Helm Notes ==="
                  helm get notes "${{ env.CAMUNDA_RELEASE_NAME }}" -n "${{ env.CAMUNDA_NAMESPACE }}" || true

                  echo ""
                  echo "=== Helm Hooks ==="
                  helm get hooks "${{ env.CAMUNDA_RELEASE_NAME }}" -n "${{ env.CAMUNDA_NAMESPACE }}" || true
            - name: Cleanup
              if: always()
              run: |
                  set -euo pipefail

                  echo "Cleaning up Kind cluster: ${{ env.CLUSTER_NAME }}"
                  kind delete cluster --name "${{ env.CLUSTER_NAME }}" || true
    report-success:
        name: Report success
        runs-on: ubuntu-latest
        needs:
            - integration-tests
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
            - name: Prevent other runs for renovate
              if: ${{ env.IS_RENOVATE_PR == 'true' }}
              env:
                  GH_TOKEN: ${{ github.token }}
              uses: ./.github/actions/internal-apply-skip-label
    report-failure:
        name: Report failures
        if: failure()
        runs-on: ubuntu-latest
        needs:
            - report-success
        steps:
            - name: Notify in Slack in case of failure
              id: slack-notification
              if: ${{ env.IS_SCHEDULE == 'true' }}
              uses: camunda/infraex-common-config/.github/actions/report-failure-on-slack@193a21e1e56c9a65517a822224ac3b4ffa4d6ae4
              with:
                  vault_addr: ${{ secrets.VAULT_ADDR }}
                  vault_role_id: ${{ secrets.VAULT_ROLE_ID }}
                  vault_secret_id: ${{ secrets.VAULT_SECRET_ID }}

# Scheduled trigger: 2026-01-14T22:08:23Z - Wednesday schedules 8.8
