---
name: Tests - Integration - Local Kubernetes Kind Single Region

permissions:
    contents: read
    pull-requests: write # allow comments, labels (used by internal-apply-skip-label)

on:
    schedule:
        - cron: 0 4 * * 3 # Runs at 4 AM on Wednesdays
    pull_request:
        paths:
            - .github/workflows/local_kubernetes_kind_single_region_tests.yml
            - .github/workflows-config/local-kubernetes-kind-single-region/**
            - .github/actions/internal-triage-skip/**
            - .github/actions/internal-apply-skip-label/**
            - .github/actions/internal-tests-matrix/**
            - .github/actions/internal-camunda-chart-tests/**
            - .tool-versions
            - local/kubernetes/kind-single-region/**
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: false

env:
    REF_ARCH_PATH: local/kubernetes/kind-single-region
    IS_SCHEDULE: ${{ contains(github.head_ref, 'schedules/') || github.event_name == 'schedule' && 'true' || 'false' }}
    IS_RENOVATE_PR: ${{ github.event_name == 'pull_request' && github.event.pull_request.user.login == 'renovate[bot]' }}
    CI_MATRIX_FILE: .github/workflows-config/local-kubernetes-kind-single-region/test_matrix.yml

    # TEST VARIABLES
    TESTS_ENABLED: 'true'
    # renovate: datasource=github-tags depName=camunda/camunda-platform-helm
    TESTS_CAMUNDA_HELM_CHART_REPO_REF: fix-venom-8-8   # git reference used to clone the camunda/camunda-platform-helm repository to perform the tests
    TESTS_CAMUNDA_HELM_CHART_REPO_PATH: ./.camunda_helm_repo   # where to clone it

jobs:
    triage:
        runs-on: ubuntu-latest
        outputs:
            should_skip: ${{ steps.skip_check.outputs.should_skip }}
        steps:
            - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
            - name: Check labels
              id: skip_check
              uses: ./.github/actions/internal-triage-skip

    clusters-info:
        needs: triage
        if: needs.triage.outputs.should_skip == 'false'
        name: Define Matrix
        runs-on: ubuntu-latest
        outputs:
            platform-matrix: ${{ steps.matrix.outputs.platform_matrix }}
        steps:
            - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

            - name: Install asdf tools with cache
              uses: camunda/infraex-common-config/./.github/actions/asdf-install-tooling@eb9d51b4dc89deeda7fc160166f378725ee0f06a # 1.5.3

            - name: Define tests matrix
              uses: ./.github/actions/internal-tests-matrix
              id: matrix
              with:
                  ci_matrix_file: ${{ env.CI_MATRIX_FILE }}
                  cluster_prefix: kind-${{ github.event.pull_request.number || '' }}
                  is_schedule: ${{ env.IS_SCHEDULE }}
                  is_renovate_pr: ${{ env.IS_RENOVATE_PR }}

    integration-tests:
        name: Test ${{ matrix.distro.name }} - ${{ matrix.declination.name }}
        needs:
            - triage
            - clusters-info
        if: needs.triage.outputs.should_skip == 'false'
        runs-on: ubuntu-latest
        timeout-minutes: 45
        strategy:
            fail-fast: false
            matrix:
                distro: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).distro }}
                scenario: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).scenario }}
                declination: ${{ fromJson(needs.clusters-info.outputs.platform-matrix).declination }}
        env:
            CLUSTER_NAME: camunda-${{ matrix.declination.cluster_suffix }}
            CAMUNDA_NAMESPACE: camunda
            CAMUNDA_RELEASE_NAME: camunda
            TEST_CLUSTER_TYPE: kubernetes
        steps:
            - name: Checkout repository
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

            - name: Install asdf tools with cache
              uses: camunda/infraex-common-config/./.github/actions/asdf-install-tooling@eb9d51b4dc89deeda7fc160166f378725ee0f06a # 1.5.3

            - name: Import Secrets
              id: secrets
              uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3
              with:
                  url: ${{ secrets.VAULT_ADDR }}
                  method: approle
                  roleId: ${{ secrets.VAULT_ROLE_ID }}
                  secretId: ${{ secrets.VAULT_SECRET_ID }}
                  exportEnv: false
                  secrets: |
                      secret/data/products/infrastructure-experience/ci/common DOCKERHUB_USER;
                      secret/data/products/infrastructure-experience/ci/common DOCKERHUB_PASSWORD;
                      secret/data/products/infrastructure-experience/ci/common CI_CAMUNDA_USER_TEST_CLIENT_ID;
                      secret/data/products/infrastructure-experience/ci/common CI_CAMUNDA_USER_TEST_CLIENT_SECRET;

            - name: Update Kind cluster config with unique name and ports
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  # Update cluster name in config to avoid conflicts
                  sed -i "s/camunda-platform-local/${{ env.CLUSTER_NAME }}/g" configs/kind-cluster-config.yaml

                  # Update ports to avoid conflicts when running in parallel
                  # domain mode: 80/443, no-domain mode: 8080/8443
                  if [[ "${{ matrix.declination.use_tls }}" == "false" ]]; then
                      sed -i "s/hostPort: 80$/hostPort: 8080/g" configs/kind-cluster-config.yaml
                      sed -i "s/hostPort: 443$/hostPort: 8443/g" configs/kind-cluster-config.yaml
                  fi

                  echo "=== Kind cluster config ==="
                  cat configs/kind-cluster-config.yaml

                  # Patch cluster-create.sh to use the updated cluster name
                  sed -i "s/camunda-platform-local/${{ env.CLUSTER_NAME }}/g" procedure/cluster-create.sh

            - name: Create Kind cluster
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: ./procedure/cluster-create.sh

            - name: Deploy Ingress NGINX
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: ./procedure/ingress-nginx-deploy.sh

            # Domain mode specific steps
            - name: Configure CoreDNS
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  ./procedure/coredns-config.sh

            - name: Generate TLS certificates
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  ./procedure/certs-generate.sh

            - name: Create TLS secret
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  ./procedure/certs-create-secret.sh

            - name: Create CA ConfigMap
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  ./procedure/certs-create-ca-configmap.sh

            # Prepare test environment
            - name: Create test secrets for integration tests
              if: env.TESTS_ENABLED == 'true'
              run: |
                  set -euo pipefail

                  echo "Creating identity secret for test client..."
                  kubectl create secret generic identity-secret-for-components-integration \
                      --from-literal=identity-admin-client-id="${{ steps.secrets.outputs.CI_CAMUNDA_USER_TEST_CLIENT_ID }}" \
                      --from-literal=identity-admin-client-secret="${{ steps.secrets.outputs.CI_CAMUNDA_USER_TEST_CLIENT_SECRET }}" \
                      --namespace="${{ env.CAMUNDA_NAMESPACE }}"

            - name: Prepare Helm values with test client
              if: env.TESTS_ENABLED == 'true'
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  echo "Merging identity.yml test values into helm values..."

                  # Merge test identity values into domain values
                  if [[ -f helm-values/values-domain.yml ]]; then
                      yq ". *+ load(\"../../../generic/kubernetes/single-region/tests/helm-values/identity.yml\")" \
                          helm-values/values-domain.yml > helm-values/values-domain-with-tests.yml
                      mv helm-values/values-domain-with-tests.yml helm-values/values-domain.yml
                      echo "âœ… Merged test client into values-domain.yml"
                  fi

                  # Merge test identity values into no-domain values
                  if [[ -f helm-values/values-no-domain.yml ]]; then
                      yq ". *+ load(\"../../../generic/kubernetes/single-region/tests/helm-values/identity.yml\")" \
                          helm-values/values-no-domain.yml > helm-values/values-no-domain-with-tests.yml
                      mv helm-values/values-no-domain-with-tests.yml helm-values/values-no-domain.yml
                      echo "âœ… Merged test client into values-no-domain.yml"
                  fi

            # Deploy Camunda
            - name: Deploy Camunda (domain mode)
              if: matrix.declination.use_tls
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  ./procedure/camunda-deploy-domain.sh

            - name: Deploy Camunda (no-domain mode)
              if: ${{ !matrix.declination.use_tls }}
              working-directory: ${{ env.REF_ARCH_PATH }}
              run: |
                  set -euo pipefail

                  ./procedure/camunda-deploy-no-domain.sh

            - name: Wait for Camunda deployment
              timeout-minutes: 20
              env:
                  CAMUNDA_NAMESPACE: ${{ env.CAMUNDA_NAMESPACE }}
              run: ./generic/kubernetes/single-region/procedure/check-deployment-ready.sh

            - name: Verify Helm release
              run: |
                  set -euo pipefail

                  echo "=== Helm Release ==="
                  helm list -n "${{ env.CAMUNDA_NAMESPACE }}"

                  echo ""
                  echo "=== All Resources ==="
                  kubectl get all -n "${{ env.CAMUNDA_NAMESPACE }}"


            - name: Set Camunda domain environment variables
              run: |
                  set -euo pipefail

                  if [[ "${{ matrix.declination.use_tls }}" == "true" ]]; then
                      echo "CAMUNDA_DOMAIN=camunda.example.com" | tee -a "$GITHUB_ENV"
                      echo "CAMUNDA_GRPC_DOMAIN=zeebe-camunda.example.com:443" | tee -a "$GITHUB_ENV"
                  else
                      echo "CAMUNDA_DOMAIN=" | tee -a "$GITHUB_ENV"
                      echo "CAMUNDA_GRPC_DOMAIN=" | tee -a "$GITHUB_ENV"
                  fi

            - name: Set current Camunda version
              id: camunda-version
              run: |
                  set -euo pipefail

                  CAMUNDA_VERSION=$(cat .camunda-version)
                  echo "CAMUNDA_VERSION=$CAMUNDA_VERSION" | tee -a "$GITHUB_OUTPUT"

            - name: ðŸ§ª Run Camunda Platform tests
              if: env.TESTS_ENABLED == 'true'
              timeout-minutes: 30
              uses: ./.github/actions/internal-camunda-chart-tests
              with:
                  secrets: ${{ toJSON(secrets) }}
                  camunda-version: ${{ steps.camunda-version.outputs.CAMUNDA_VERSION }}
                  camunda-domain: ${{ env.CAMUNDA_DOMAIN }}
                  camunda-domain-grpc: ${{ env.CAMUNDA_GRPC_DOMAIN }}
                  webmodeler-enabled: 'true'
                  console-enabled: 'true'
                  tests-camunda-helm-chart-repo-ref: ${{ env.TESTS_CAMUNDA_HELM_CHART_REPO_REF }}
                  tests-camunda-helm-chart-repo-path: ${{ env.TESTS_CAMUNDA_HELM_CHART_REPO_PATH }}
                  test-namespace: ${{ env.CAMUNDA_NAMESPACE }}
                  test-cluster-type: ${{ env.TEST_CLUSTER_TYPE }}
                  test-release-name: ${{ env.CAMUNDA_RELEASE_NAME }}
                  test-client-id: ${{ steps.secrets.outputs.CI_CAMUNDA_USER_TEST_CLIENT_ID }}
                  test-client-secret: ${{ steps.secrets.outputs.CI_CAMUNDA_USER_TEST_CLIENT_SECRET }}
                  # C8 SM checks configuration
                  enable-c8sm-irsa-check: 'false'

            - name: ðŸ”¬ðŸš¨ Debug - Show pod details on failure
              if: failure()
              run: |
                  set -euo pipefail

                  echo "=== Pod Status ==="
                  kubectl get pods -n "${{ env.CAMUNDA_NAMESPACE }}" -o wide

                  echo ""
                  echo "=== Events ==="
                  kubectl get events -n "${{ env.CAMUNDA_NAMESPACE }}" --sort-by='.lastTimestamp' | tail -50

                  echo ""
                  echo "=== Failed Pods Details ==="
                  kubectl get pods -n "${{ env.CAMUNDA_NAMESPACE }}" --no-headers | grep -v "Running\|Completed" | awk '{print $1}' | while read -r pod; do
                      if [[ -n "$pod" ]]; then
                          echo "--- Pod: $pod ---"
                          kubectl describe pod "$pod" -n "${{ env.CAMUNDA_NAMESPACE }}" | tail -30
                          echo ""
                          echo "--- Logs: $pod ---"
                          kubectl logs "$pod" -n "${{ env.CAMUNDA_NAMESPACE }}" --all-containers --tail=50 || true
                          echo ""
                      fi
                  done

            - name: ðŸ”¬ðŸš¨ Debug - Show Helm status on failure
              if: failure()
              run: |
                  set -euo pipefail

                  echo "=== Helm Status ==="
                  helm status "${{ env.CAMUNDA_RELEASE_NAME }}" -n "${{ env.CAMUNDA_NAMESPACE }}" || true

                  echo ""
                  echo "=== Helm History ==="
                  helm history "${{ env.CAMUNDA_RELEASE_NAME }}" -n "${{ env.CAMUNDA_NAMESPACE }}" || true

            - name: Cleanup
              if: always()
              run: |
                  set -euo pipefail

                  echo "Cleaning up Kind cluster: ${{ env.CLUSTER_NAME }}"
                  kind delete cluster --name "${{ env.CLUSTER_NAME }}" || true

    report-success:
        name: Report success
        runs-on: ubuntu-latest
        needs:
            - integration-tests
        steps:
            - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

            - name: Prevent other runs for renovate
              if: ${{ env.IS_RENOVATE_PR == 'true' }}
              env:
                  GH_TOKEN: ${{ github.token }}
              uses: ./.github/actions/internal-apply-skip-label

    report-failure:
        name: Report failures
        if: failure()
        runs-on: ubuntu-latest
        needs:
            - report-success
        steps:
            - name: Notify in Slack in case of failure
              id: slack-notification
              if: ${{ env.IS_SCHEDULE == 'true' }}
              uses: camunda/infraex-common-config/.github/actions/report-failure-on-slack@eb9d51b4dc89deeda7fc160166f378725ee0f06a # 1.5.3
              with:
                  vault_addr: ${{ secrets.VAULT_ADDR }}
                  vault_role_id: ${{ secrets.VAULT_ROLE_ID }}
                  vault_secret_id: ${{ secrets.VAULT_SECRET_ID }}
